<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free and open-source book about Zend Framework">
<meta name="keywords" content="php,zend framework,book,tutorial,documentation,learn,free">
<meta name="author" content="(c) 2018 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>О менеджере сущностей -- Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free and open-source book about Zend Framework            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Read</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/zf3-api-reference/html/">Class Reference</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Управление_базой_данных_с_помощью_ORM_Doctrine/Создание_сущностей.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Управление_базой_данных_с_помощью_ORM_Doctrine/Добавление_главной_страницы_блога.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Управление_базой_данных_с_помощью_ORM_Doctrine.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Управление базой данных с помощью ORM Doctrine</span>
        </a>
    </div>
    </div>

﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Book - Chapter - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="4531860323"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Chapter content -->
<div id="chapter_content">

<h2 id="О_менеджере_сущностей">12.7. О менеджере сущностей</h2>
<p><em>Менеджер сущностей</em> - это основная точка доступа к функциональности ORM.</p>
<blockquote class="notquote information" data-type="information"><p> <code>EntityManager</code> - это класс Doctrine, который "живет" в пространстве имен <code>Doctrine\ORM</code> и 
 используется для извлечения сущностей из их репозиториев с помощью критериев поиска, а также 
 для их сохранения в базу данных. </p>
</blockquote><p><code>EntityManager</code> зарегистрирован в качестве сервиса в менеджере сервисов Zend Framework 3.
Он извлекается из менеджера сервисов в классе фабрики следующим образом (если вам нужно
другое соединение, просто замените <code>orm_default</code> именем необходимого соединения):</p>
<pre class=""><code class="language-php">// Получаем менеджер сущностей Doctrine
$entityManager = $container-&gt;get('doctrine.entitymanager.orm_default');   
</code></pre>
<p>Наиболее часто используемые методы класса <code>EntityManager</code> перечислены в таблице 12.4 ниже.</p>
<div class="table-wrapper">
<div class="table-caption">Таблица 12.4. Методы EntityManager</div><table>
<thead>
<tr>
<th> <em>Метод</em>                            </th>
<th> <em>Описание</em>                                       </th>
</tr>
</thead>
<tbody>
<tr>
<td>  <code>persist($entity)</code>                 </td>
<td>  Помещает новую сущность в менеджер сущностей (делает ее управляемой). </td>
</tr>
<tr>
<td> <code>remove($entity)</code>                  </td>
<td> Удаляет сущность из базы данных.                 </td>
</tr>
<tr>
<td> <code>flush()</code>                          </td>
<td> Сбрасывает все изменения объектов в очереди в базу. </td>
</tr>
<tr>
<td> <code>createQuery($dql)</code>                </td>
<td> Создает новый объект Query.                      </td>
</tr>
<tr>
<td> <code>getRepository($entityName)</code>       </td>
<td> Получает репозиторий класса сущности.            </td>
</tr>
</tbody>
</table>
</div>
<p>Давайте рассмотрим методы из таблицы 12.4.</p>
<p>Чтобы добавить недавно созданную сущность в менеджер сущностей (чтобы сделать ее "управляемой"),
используйте метод менеджера сущностей <code>persist()</code>.
Чтобы удалить сущность из базы данных, воспользуйтесь методом <code>remove()</code>.</p>
<p>Когда вы вызываете методы <code>persist()</code> или <code>remove()</code>, <code>EntityManager</code> запоминает ваши изменения
в памяти, но не применяет их к базе данных автоматически (из соображений производительности).
Чтобы применить все изменения к БД разом, используйте метод <code>flush()</code>.</p>
<p>Пример кода ниже, показывает, как создать экземпляр сущности <code>Post</code> и сохранить его в базе данных:</p>
<pre class=""><code class="language-php">// Создаем новую сущность Post.
$post = new Post();
$post-&gt;setTitle('Top 10+ Books about Zend Framework 3');
$post-&gt;setContent('Post body goes here');
$post-&gt;setStatus(Post::STATUS_PUBLISHED);
$currentDate = date('Y-m-d H:i:s');
$post-&gt;setDateCreated($currentDate);        

// Добавляем сущность в менеджер сущностей.
$entityManager-&gt;persist($post);

// Применяем изменения к БД.
$entityManager-&gt;flush();
</code></pre>
<p>Метод менеджера сущностей <code>createQuery()</code> предназначен для создания запроса из DQL-строки. Он возвращает
объект <code>Query</code>. Затем вы можете выполнить запрос и получить результаты (массив сущностей, соответствующих
условиям поиска).</p>
<p>Метод <code>getRepository()</code> предназначен для получения репозитория по имени класса сущности. Ниже вы можете
увидеть пример, где мы получаем репозиторий для нашей сущности <code>Post</code>:</p>
<pre class=""><code class="language-php">$repository = $entityManager-&gt;getRepository(Post::class);
</code></pre>
<h3 id="Репозитории_сущностей">12.7.1. Репозитории сущностей</h3>
<p>Теоретически, у каждого класса сущности есть свой репозиторий. Репозиторий предоставляет методы
для извлечения сущностей из базы данных. Репозиторий можно считать коллекцией всех доступных
сущностей определенного класса. Например, существуют репозитории для созданных нами сущностей
<code>Post</code>, <code>Comment</code>, и <code>Tag</code>.</p>
<p>Для того, чтобы загрузить данные из БД, нужно извлечь сущность из ее репозитория. Когда вы
запрашиваете у репозитория сущность, он загружает данные из таблицы, сопоставляемой с этой
сущностью, и присваивает данные полям сущности.</p>
<blockquote class="notquote information" data-type="information"><p> Класс <code>Doctrine\ORM\EntityRepository</code> реализует репозиторий по умолчанию. При необходимости,
 расширив <code>EntityRepository</code>, вы можете создать свой собственный репозиторий для определенного 
 класса сущности. Позже мы покажем, как это сделать.</p>
</blockquote><p>Наиболее часто используемые методы класса <code>EntityRepository</code> перечислены в таблице 12.5.</p>
<div class="table-wrapper">
<div class="table-caption">Таблица 12.5. Методы EntityRepository</div><table>
<thead>
<tr>
<th> <em>Метод</em>                            </th>
<th> <em>Описание</em>                                       </th>
</tr>
</thead>
<tbody>
<tr>
<td>  <code>findAll()</code>                        </td>
<td>  Находит все сущности в репозитории.              </td>
</tr>
<tr>
<td> <code>find($id)</code>                        </td>
<td> Находит сущность по ее идентификатору.           </td>
</tr>
<tr>
<td> <code>findBy($criteria, $orderBy, $limit, $offset)</code> </td>
<td> Находит сущности по набору критериев.</td>
</tr>
<tr>
<td> <code>findOneBy($criteria, $orderBy)</code>    </td>
<td> Находит одну сущность по набору критериев.      </td>
</tr>
<tr>
<td> <code>createQueryBuilder($alias)</code>       </td>
<td> Создает новый экземпляр QueryBuilder, предзаполненный для этого имени сущности. </td>
</tr>
</tbody>
</table>
</div>
<p>Метод <code>findAll()</code> получает все сущности из репозитория. Простой пример его использования показан ниже:</p>
<pre class=""><code class="language-php">// Находит все посты в репозитории.
$posts = $entityManager-&gt;getRepository(Post::class)-&gt;findAll();
</code></pre>
<p>Метод <code>find()</code> - самый простой метод для поиска сущности. Он извлекает сущность
по ее ID (первичному ключу).</p>
<p>В примере ниже мы выбираем пост с ID = 1.</p>
<pre class=""><code class="language-php">// Находим пост по первичному ключу (ID).
$post = $entityManager-&gt;getRepository(Post::class)-&gt;find(1);
</code></pre>
<p><code>findBy()</code> принимает критерии поиска (и, опционально, порядок сортировки и границы) и
возвращает коллекцию сущностей, соответствующих критериям. Метод <code>findOneBy()</code> очень похож
на <code>findBy()</code>, однако он возвращает первую соответствующую критериям сущность.</p>
<p>В следующем примере кода мы используем метод <code>findBy()</code> для выбора 50 последних опубликованных
постов:</p>
<p>In the code example below, we use the <code>findBy()</code> method for selecting 50 most recent published posts:</p>
<pre class=""><code class="language-php">// Находим 50 последних опубликованных постов
$posts = $entityManager-&gt;getRepository(Post::class)-&gt;findBy(
           ['status'=&gt;Post::STATUS_PUBLISHED], 
           ['dateCreated'=&gt;'DESC'], 50);
</code></pre>
<p>Для удобства, класс <code>EntityRepository</code> также предоставляет магические методы, позволяющие запрашивать сущности
по имени атрибута с помощью методов <code>findByX</code> and <code>findOneByX</code>, следующим способом (просто замените плейсхолдер X
именем атрибута):</p>
<pre class=""><code class="language-php">// Запрашивает один пост по его атрибуту ID
$post = $entityManager-&gt;getRepository(Post::class)-&gt;findOneById(1);

// Запрашивает посты по атрибуту статуса
$posts = $entityManager-&gt;getRepository(Post::class)
        -&gt;findByStatus(Post::STATUS_PUBLISHED);
</code></pre>
<p>И наконец, наиболее сложный метод поиска - метод <code>createQueryBuilder()</code>. Он позволяет создавать
сложные DQL-запросы.</p>
<p>Если стандартных методов поиска недостаточно (или у вас сложные критерии поиска и DQL-запросы),
вы можете создать свой собственный репозиторий, расширив стандартный класс <code>EntityRepository</code> и
инкапсулировав в него алгоритм поиска. Мы покажем, как это сделать, позже, при реализации 
облака тегов для нашего приложения <em>Blog</em>.</p>
        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Chapter - Bottom - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="1546211126"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Управление_базой_данных_с_помощью_ORM_Doctrine.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Управление базой данных с помощью ORM Doctrine</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Управление_базой_данных_с_помощью_ORM_Doctrine/Создание_сущностей.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Управление_базой_данных_с_помощью_ORM_Doctrine/Добавление_главной_страницы_блога.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright (c) 2018 by Oleg Krivtsov            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a>
            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

