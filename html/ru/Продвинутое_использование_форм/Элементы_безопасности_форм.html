<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free and open-source book about Zend Framework">
<meta name="keywords" content="php,zend framework,book,tutorial,documentation,learn,free">
<meta name="author" content="(c) 2017 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Элементы безопасности форм -- Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free and open-source book about Zend Framework            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Read</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Продвинутое_использование_форм.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Продвинутое_использование_форм/Использование_групп_валидации.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Продвинутое_использование_форм.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Продвинутое использование форм</span>
        </a>
    </div>
    </div>


<!-- Chapter content -->
<div id="chapter_content">

<h2 id="Элементы_безопасности_форм">11.1. Элементы безопасности форм</h2>
<p>Мы рассмотрим использование двух предоставляемых Zend Framework 3
элементов безопасности форм: <code>Captcha</code> и <code>Csrf</code> (оба класса принадлежат
пространству имен <code>Zend\Form\Element</code>). Добавление этих элементов на модель
формы (и их визуализация в шаблоне представления) сделает вашу форму устойчивой
к хакерским атакам.</p>
<h3 id="CAPTCHA">11.1.1. CAPTCHA</h3>
<p>CAPTCHA (расшифровывается как "Completely Automated Public Turing test to 
tell Computers and Humans Apart" - "полностью автоматизированный публичный тест 
Тьюринга для различения компьютеров и людей") - это тест типа «вызов - ответ», 
используемый веб-сайтами, чтобы определить, кем является пользователь: человеком или роботом.</p>
<p>Существует несколько типов CAPTCHA. Самый распространенный требует от пользователя
ввести с клавиатуры буквы с искаженного изображения, показываемого на веб-странице
(см. рисунок 11.1).</p>
<p><span class="image-wrapper">
<a target="_blank" href="../../en/images/forms_advanced/captcha_types.png">
<img src="../../en/images/forms_advanced/captcha_types.png" alt="Рисунок 11.1. Примеры CAPTCHA" /></a>
<span class="image-caption">Рисунок 11.1. Примеры CAPTCHA</span>
</span>
</p>
<p>Типичный тест CAPTCHA использует следующий алгоритм:</p>
<ol>
<li>На стороне сервера генерируется некая скрытая последовательность символов (слово).</li>
<li>Секретное слово сохраняется в переменной сессии PHP.</li>
<li>На основе секретного слова генерируется искаженное изображение.
Затем оно отображается пользователю сайта на веб-странице.</li>
<li>Пользователю предлагается ввести показанные на изображении символы.</li>
<li>Если введенные пользователем символы совпадают с секретным словом,
сохраненным в сессии, тест считается пройденным.</li>
</ol>
<p>Целью теста CAPTCHA является защита форм от заполнения и отправки 
автоматическим процессом (так называемым роботом). Обычно такие роботы
рассылают спам-сообщения на форумах, взламывают пароли на формах входа на сайт
или совершают какие-либо другие вредоносные действия.</p>
<blockquote class="notquote information" data-type="information"><p> Тест CAPTCHA позволяет надежно различать людей и роботов, потому что люди
 легко могут распознать и воспроизвести символы с искаженного изображения,
 в отличие от роботов, которые этого не умеют (на данном этапе эволюции
 алгоритмов компьютерного зрения).</p>
</blockquote><h4 id="Типы_CAPTCHA">11.1.1.1. Типы CAPTCHA</h4>
<p>В Zend Framework 3 доступно несколько типов CAPTCHA (все принадлежат
компоненту <code>Zend\Captcha</code>):</p>
<ul>
<li><p><em>Dumb.</em> Это очень простой алгоритм CAPTCHA, который требует от пользователя 
ввести буквы слова в обратном порядке. Мы не будем рассматривать этот тип
детально, так как он предоставляет слишком низкий уровень защиты.</p>
</li>
<li><p><em>Image.</em> Алгоритм CAPTCHA, искажающий изображение добавлением
шума в виде точек и кривых линий (рисунок 11.1, а).</p>
</li>
<li><p><em>Figlet.</em> Редкий тип CAPTCHA, использующий программу FIGlet вместо алгоритма 
искажения изображения. FIGlet - это открытое программное обеспечение, генерирующее
изображение CAPTCHA множества ASCII-букв (рисунок 11.1, б).</p>
</li>
</ul>
<p>Компонент <code>Zend\Captcha</code> предоставляет единообразный интерфейс для всех типов 
CAPTCHA (интерфейс <code>AdapterInterface</code>). Базовый класс <code>AbstractAdapter</code> реализует
этот интерфейс, и все остальные алгоритмы CAPTCHA наследуются от абстрактного
класса адаптера <sup id="fnref:адаптер"><a href="#fn:адаптер" class="footnote-ref" rel="footnote">45</a></sup>. Диаграмма наследования классов показана ниже на рисунке 11.2.</p>
<p><span class="image-wrapper">
<a target="_blank" href="../../en/images/forms_advanced/captcha_adapters.png">
<img src="../../en/images/forms_advanced/captcha_adapters.png" alt="Рисунок 11.2. Классы адаптеров CAPTCHA" /></a>
<span class="image-caption">Рисунок 11.2. Классы адаптеров CAPTCHA</span>
</span>
</p>
<footnotes id="fn:адаптер"><p><sup>45)</sup> <em>Адаптер</em> - это шаблон проектирования, который преобразовывает интерфейс класса в 
совместимый интерфейс, что позволяет двум (или нескольким) несовместимым интерфейсам 
работать вместе. Как правило, у алгоритмов CAPTCHA различаются public-методы, но, так
как они все реализуют интерфейс <code>AbstractAdapter</code>, их все можно использовать
одним и тем же способом (вызывая методы, предоставляемые базовым интерфейсом)</p>
</footnotes>
<p>Как видите из рисунка 11.2, существует еще один базовый класс для всех типов CAPTCHA,
который использует некое секретное слово из символов: класс <code>AbastractWord</code>. Этот
базовый класс предоставляет методы для генерации случайной последовательности символов
и для настройки опций генерации слов.</p>
<h4 id="Элемент_формы_CAPTCHA_и_помощник_вида">11.1.1.2. Элемент формы CAPTCHA и помощник вида</h4>
<p>ZF3 предоставляет специальный класс элемента формы и класс помощника вида для использования полей CAPTCHA на формах.</p>
<p>Чтобы добавить поле CAPTCHA к модели формы, используйте класс <code>Captcha</code>, который принадлежит компоненту <code>Zend\Form</code>
и "живет" в пространстве имен <code>Zend\Form\Element</code>.</p>
<p>Класс элемента <code>Captcha</code> может быть использован с любым алгоритмом CAPTCHA (перечислены
в предыдущем разделе) из компонента <code>Zend\Captcha</code>. Для этой цели, класс элемента имеет
метод <code>setCaptcha()</code>, который принимает либо экземпляр класса, реализующего интерфейс
<code>Zend\Captcha\AdapterInterface</code>, либо массив, содержащий настройку CAPTCHA <sup id="fnref:массив"><a href="#fn:массив" class="footnote-ref" rel="footnote">46</a></sup>.
Методом <code>setCaptcha()</code> можно добавить к элементу желаемый тип CAPTCHA.</p>
<footnotes id="fn:массив"><p><sup>46)</sup> Во втором случае (описание в виде массива) алгоритм CAPTCHA будет
автоматически инстанцирован и инициализирован классом фабрики <code>Zend\Captcha\Factory</code>.</p>
</footnotes>
<p>Элемент <code>Captcha</code> добавляется к модели формы обычным способом, через метод <code>add()</code>,
предоставляемый базовым классом <code>Zend\Form\Form</code>. Как обычно, вы можете передать методу
либо экземпляр класса <code>Zend\Form\Element\Captcha</code>, либо массив опций конфигурации для
конкретного алгоритма CAPTCHA (в этом случае элемент и его алгоритм CAPTCHA будут автоматически
инстанцированы и настроены классом фабрики).</p>
<p>Пример кода ниже показывает, как использовать второй способ (передача конфигурации в виде массива).
Мы предпочитаем его, так как он требует меньше кода. Предполагается, что вы вызываете этот код
внутри protected-метода addElements()` модели формы:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
// Добавляем поле CAPTCHA к модели формы
$this-&gt;add([
  'type'  =&gt; 'captcha',
  'name' =&gt; 'captcha',
  'options' =&gt; [
    'label' =&gt; 'Human check',
    'captcha' =&gt; [
      'class' =&gt; '&lt;captcha_class_name&gt;', //
      // Здесь идут опции для конкретного класса ...
    ],
  ],
]);
</code></pre>
<p>В этом фрагменте мы вызываем метод <code>add()</code>, предоставляемый базовым классом <code>Form</code>,
и передаем ему описание элемента, который хотим добавить, в виде массива (строка 3):</p>
<ul>
<li>Ключ массива <code>type</code> (строка 4), как и обычно, может быть либо полностью определенным именем класса
элемента (<code>Zend\Form\Element\Captcha</code>), либо его псевдонимом ("captcha").</li>
<li>Ключ <code>name</code> (строка 5) - это значение атрибута "name" поля HTML-формы.</li>
<li>Ключ <code>options</code> содержии опции для присоединенного алгоритма CAPTCHA.</li>
<li>Ключ <code>class</code> (строка 9) может содержать либо полное имя класса CAPTCHA (например, <code>Zend\Captcha\Image</code>),
либо его псевдоним (например, "Image"). Другие опции, специфичные для определенного адаптера, также
могут быть добавлены к этому ключу. Немного позже мы покажем, как это сделать.</li>
</ul>
<p>Для генерации HTML-разметки для элемента, можно использовать класс помощника вида <code>FormCaptcha</code>
(принадлежащий пространству имен <code>Zend\Form\View\Helper</code>). Однако, как вы могли узнать из предыдущей
главы, как правило, вместо этого используется общий помощник вида <code>FormElement</code>, как показано в коде ниже:</p>
<pre class=""><code class="language-text">&lt;?= $this-&gt;formElement($form-&gt;get('captcha')); ?&gt;
</code></pre>
<p>Предполагается, что вы вызываете помощник вида внутри шаблона представления.</p>
<p>Далее мы приведем два примера, показывающие, как использовать два разных типа CAPTCHA, 
предоставляемых ZF3: <code>Image</code> и <code>Figlet</code>. Мы покажем, как добавить поле CAPTCHA к форме
обратной связи, которую мы использовали в примерах предыдущих глав.</p>
<h4 id="Пример_1__Добавление_CAPTCHA_типа_Image_к_ContactForm">11.1.1.3. Пример 1: Добавление CAPTCHA типа Image к ContactForm</h4>
<blockquote class="notquote warning" data-type="warning"><p> Для CAPTCHA типа Image требуется установленное PHP-расширение GD с поддержкой PNG 
 и шрифтами FT. </p>
</blockquote><p>Чтобы добавить CAPTCHA <code>Image</code> к модели формы, вызовите метод формы
<code>add()</code> как показано ниже:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
namespace Application\Form;
// ...

class ContactForm extends Form
{
    // ...    
    protected function addElements() 
    {
        // ...         
       
        // Add the CAPTCHA field
        $this-&gt;add([
            'type'  =&gt; 'captcha',
            'name' =&gt; 'captcha',
            'attributes' =&gt; [
            ],
            'options' =&gt; [
                'label' =&gt; 'Human check',
                'captcha' =&gt; [
                    'class' =&gt; 'Image',
                    'imgDir' =&gt; 'public/img/captcha',
                    'suffix' =&gt; '.png',
                    'imgUrl' =&gt; '/img/captcha/',
                    'imgAlt' =&gt; 'CAPTCHA Image',
                    'font'   =&gt; './data/font/thorne_shaded.ttf',
                    'fsize'  =&gt; 24,
                    'width'  =&gt; 350,
                    'height' =&gt; 100,
                    'expiration' =&gt; 600, 
                    'dotNoiseLevel' =&gt; 40,
                    'lineNoiseLevel' =&gt; 3
                ],
            ],
        ]);
    }
}
</code></pre>
<p>В этом фрагменте ключ массива конфигурации <code>captcha</code> (строка 20) содержит следующие
параметры для настройки алгоритма CAPTCHA <code>Image</code>, присоединенного к элементу формы:</p>
<ul>
<li><p>параметр <code>class</code> (строка 21) должен быть либо полностью определенным именем класса 
адаптера CAPTCHA (<code>\Zend\Captcha\Image</code>), либо его псевдоним (<code>Image</code>).</p>
</li>
<li><p>параметр <code>imgDir</code> parameter (line 22) должен быть путем к каталогу, куда нужно 
сохранять сгенерированные искаженные изображения (в этом примере мы будем сохранять)
изображения в каталог <em>APP_DIR/public/img/captcha</em>).</p>
</li>
<li><p>параметр <code>suffix</code> (строка 23) определяет расширение для сгенерированного файла
изображения (в этом примере - ".png").</p>
</li>
<li><p>параметр <code>imgUrl</code> (строка 24) определяет базовую частью URL для открытия сгенерированных
изображений CAPTCHA в веб-браузере. В этом примере посетители сайта смогут обратиться к
изображениям CAPTCHA используя URL типа "http://localhost/img/captcha/&lt;ID&gt;", где ID - 
уникальный идентификатор определенного изображения.</p>
</li>
<li><p>опциональный параметр <code>imgAlt</code> (строка 25) - это альтернативный текст, который показывается, если изображение
CAPTCHA не может быть загружено браузером (атрибут "alt" тега `<img>).</p>
</li>
<li><p>параметр <code>font</code> (строка 26) - это путь к файлу шрифта. Вы можете скачать бесплатный шрифт TTF, 
например, <a href="http://www.1001freefonts.com/">отсюда</a>. В этом примере мы используем шрифт <em>Thorne Shaded</em>, 
который мы скачали и поместили в файл <em>APP_DIR/data/font/thorne_shaded.ttf</em>.</p>
</li>
<li><p>параметр <code>fsize</code> (строка 27) - положительное число типа integer, определяющее размер шрифта.</p>
</li>
<li><p>параметры <code>width</code> (строка 28) и <code>height</code> (строка 29) определяют соответственно ширину и высоту (в пикселях) 
сгенерированного изображения.</p>
</li>
<li><p>параметр <code>expiration</code> (строка 30) определяет срок действия изображений CAPTCHA (в секундах). 
Как только срок действия изображения истекает, оно удаляется с диска.</p>
</li>
<li><p>параметры <code>dotNoiseLevel</code> (строка 31) и <code>lineNoiseLevel</code> (строка 32) определяют
опции генерации изображения (уровни точечного и линейного шумов соответственно).</p>
</li>
</ul>
<p>Для визуализации поля CAPTCHA добавьте следующие строки в файл шаблона
представления <em>contact-us.phtml</em> :</p>
<pre class=""><code class="language-php">&lt;div class="form-group"&gt;
  &lt;?= $this-&gt;formLabel($form-&gt;get('captcha')); ?&gt;
  &lt;?= $this-&gt;formElement($form-&gt;get('captcha')); ?&gt;
  &lt;?= $this-&gt;formElementErrors($form-&gt;get('captcha')); ?&gt;
  &lt;p class="help-block"&gt;Введите буквы, которые вы видите на изображении выше.&lt;p&gt;
&lt;/div&gt;
</code></pre>
<p>Теперь создадим каталог <em>APP_DIR/public/img/captcha</em>, который будет хранить сгенерированные
изображение CAPTCHA. Отрегулируем права доступа к каталогу, чтобы он был доступным для записи 
для веб-сервера Apache. В Linux Ubuntu это, как правило, совершается следующими командами оболочки 
(замените плейсхолдер <code>APP_DIR</code> именем каталога вашего веб-приложения):</p>
<p><code>mkdir APP_DIR/public/img/captcha</code></p>
<p><code>chown -R www-data:www-data APP_DIR</code></p>
<p><code>chmod -R 775 APP_DIR</code></p>
<p>Команда <code>mkdir</code> создает каталог, а команды <code>chown</code> и <code>chmod</code> соответственно назначают 
пользователя Apache владельцем каталога и позволяют веб-серверу записывать данные в каталог.</p>
<p>Если вы теперь откроете страницу "http://localhost/contactus" в своем браузере,
будет сгенерировано изображение CAPTCHA, основанное на случайной последовательности
букв и цифр, сохраненных в сессии. Вы должны будете увидеть что-то вроде рисунка 11.3.</p>
<p><span class="image-wrapper">
<a target="_blank" href="../../en/images/forms_advanced/image_captcha_page.png">
<img src="../../en/images/forms_advanced/image_captcha_page.png" alt="Рисунок 11.3. CAPTCHA типа Image" /></a>
<span class="image-caption">Рисунок 11.3. CAPTCHA типа Image</span>
</span>
</p>
<p>Когда вы заполните поля формы и нажмете кнопку <em>Submit</em>, введенные в поле <em>Human check</em>
буквы будут переданы серверу как часть HTTP-запроса. Затем, при валидации формы, класс
<code>Zend\Form\Element\Captcha</code> сравнит отправленные буквы с теми, что хранятся в PHP-сессии.
Если буквы идентичны, форма считается действительной; иначе форма не проходит валидацию.</p>
<p>Как только визуализатор PHP обработает шаблон представления, он сгенерирует HTML-разметку
для элемента CAPTCHA как показано ниже:</p>
<pre class=""><code class="language-text">&lt;div class="form-group"&gt;
  &lt;label for="captcha"&gt;Human check&lt;/label&gt;
  &lt;img width="350" height="100" alt="CAPTCHA Image" 
       src="/img/captcha/df344b37500dcbb0c4d32f7351a65574.png"&gt;
  &lt;input name="captcha[id]" type="hidden" 
         value="df344b37500dcbb0c4d32f7351a65574"&gt;
  &lt;input name="captcha[input]" type="text"&gt;                              
  &lt;p class="help-block"&gt;Введите буквы, которые вы видите на изображении выше.&lt;/p&gt;
&lt;/div&gt;
</code></pre>
<h4 id="Пример_2__Добавление_CAPTCHA_типа_FIGlet_к_ContactForm">11.1.1.4. Пример 2: Добавление CAPTCHA типа FIGlet к ContactForm</h4>
<p>Для использования на форме элемента CAPTCHA типа FIGlet, замените определение
элемента формы из предыдущего примера следующим кодом:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
// Добавляем поле CAPTCHA
$this-&gt;add([
	'type'  =&gt; 'captcha',
	'name' =&gt; 'captcha',
	'attributes' =&gt; [                                                
	],
	'options' =&gt; [
		'label' =&gt; 'Human check',
		'captcha' =&gt; [
			'class' =&gt; 'Figlet',
			'wordLen' =&gt; 6,
			'expiration' =&gt; 600,                     
		],
	],
]);
</code></pre>
<p>В этом фрагменте ключ массива конфигурации <code>captcha</code> (строка 10) содержит следующие
параметры для настройки алгоритма CAPTCHA <code>Figlet</code>, присоединенного к элементу формы:</p>
<ul>
<li><p>параметр <code>class</code> (строка 11) должен быть либо полностью определенным именем класса 
адаптера CAPTCHA (<code>\Zend\Captcha\Figlet</code>), либо его псевдоним (<code>Figlet</code>).</p>
</li>
<li><p>параметр <code>wordLen</code> (строка 12) длину генерируемого секретного слова.</p>
</li>
<li><p>параметр <code>expiration</code> (строка 13) определяет срок действия CAPTCHA (в секундах).</p>
</li>
</ul>
<p>Теперь откройте страницу "http://localhost/contactus" в своем браузере. Вы должны будете
увидеть страницу как на рисунке 11.4 ниже.</p>
<p><span class="image-wrapper">
<a target="_blank" href="../../en/images/forms_advanced/figlet_captcha_page.png">
<img src="../../en/images/forms_advanced/figlet_captcha_page.png" alt="Рисунок 11.4. CAPTCHA типа FIGlet" /></a>
<span class="image-caption">Рисунок 11.4. CAPTCHA типа FIGlet</span>
</span>
</p>
<p>Как только визуализатор PHP обработает шаблон представления, он сгенерирует HTML-разметку
для элемента CAPTCHA как показано ниже:</p>
<pre class=""><code class="language-text">&lt;div class="form-group"&gt;
  &lt;label for="captcha"&gt;Проверка пользователя&lt;/label&gt;            
    &lt;pre&gt; 
 __   _    __   __   _    _      ___     _    _    __   __  
| || | ||  \ \\/ // | \  / ||   / _ \\  | || | ||  \ \\/ // 
| '--' ||   \ ` //  |  \/  ||  | / \ || | || | ||   \ ` //  
| .--. ||    | ||   | .  . ||  | \_/ || | \\_/ ||    | ||   
|_|| |_||    |_||   |_|\/|_||   \___//   \____//     |_||   
`-`  `-`     `-`'   `-`  `-`    `---`     `---`      `-`'   
                                                           
&lt;/pre&gt;
&lt;input name="captcha[id]" type="hidden" 
       value="b68b010eccc22e78969764461be62714"&gt;
&lt;input name="captcha[input]" type="text"&gt;                              
&lt;p class="help-block"&gt;Введите буквы, которые вы видите на изображении выше.&lt;/p&gt;
&lt;/div&gt;
</code></pre>
<h3 id="Предотвращение_подделки_межсайтовых_запросов__CSRF_">11.1.2. Предотвращение подделки межсайтовых запросов (CSRF)</h3>
<p>Подделка межсайтовых запросов (Сross Site Request Forgery - CSRF) - тип хакерской атаки,
заставляющий браузер пользователя передать HTTP-запрос произвольному сайту. Через атаку
CSRF вредоносный скрипт может послать неавторизованные команды от доверенного пользователя.
Такая атака, как правило, совершается на страницы, содержащие формы для отправки каких-либо 
уязвимых данным (например, формы для перевода денег, корзины и т.д.)</p>
<p>Чтобы лучше понять, как работает эта атака, посмотрите на рисунок 11.5.</p>
<p><span class="image-wrapper">
<a target="_blank" href="../../en/images/forms_advanced/csrf_scheme.png">
<img src="../../en/images/forms_advanced/csrf_scheme.png" alt="Рисунок 11.5. Пример CSRF-атаки" /></a>
<span class="image-caption">Рисунок 11.5. Пример CSRF-атаки</span>
</span>
</p>
<p>Рисунок 11.5 демонстрирует пример CSRF-атаки на веб-сайт платежного шлюза:</p>
<ol>
<li><p>Вы заходите на свой аккаунт на сайте платежного шлюза <em>https://payment.com</em>. Заметьте,
что в данном случае используется SSL-защищенное соединение (HTTPS), но оно не защищает
от такого рода атак.</p>
</li>
<li><p>Как правило, вы устанавливаете флажок формы входа на сайт "Remember Me" (запомнить меня), чтобы
избежать слишком частого ввода своих имени пользователя и пароля. Как только вы заходите на свой 
аккаунт, ваш браузер сохраняет информацию о сессии в переменную cookie на вашем компьютере.</p>
</li>
<li><p>На сайте платежного шлюза вы используете платежную форму <em>https://payment.com/moneytransfer.php</em> для
покупки товаров. Обратите внимание, что эта форма позже будет использована в качестве уязвимости, что
позволит осуществить CSRF-атаку.</p>
</li>
<li><p>Затем вы используете этот же браузер, чтобы посетить какой-либо сайт. Предположим,
это будет веб-сайт с классными картинками <em>http://coolpictures.com</em>. К сожалению,
этот сайт заражен вредоносным скриптом, замаскированным под HTML-тег <code>&lt;img src="image.php"&gt;</code>.
Как только вы откроете HTML-страницу в своем браузере, она загрузит все свои изображения,
тем самым выполним вредоносный скрипт <em>image.php</em>.</p>
</li>
<li><p>Вредоносный скрипт проверяет переменную cookie и, если таковая есть, он
совершает захват сессии (session riding), что позволяет ему действовать
от имени залогиненного пользователя. Теперь скрипт может отправлять данные
платежной формы на сайт платежного шлюза.</p>
</li>
</ol>
<blockquote class="notquote information" data-type="information"><p> Описанная выше CSRF-атака возможна в том случае, если веб-форма на сайте платежного 
 шлюза не проверяет источник HTTP-запроса. Те, кто занимается поддержкой подобных сайтов,
 должны уделять больше внимания созданию максимально безопасных форм.</p>
</blockquote><p>Чтобы предотвратить CSRF-атаку на форму, необходимо требовать специальный токен формы. Эта процедура описана ниже:</p>
<p>To prevent CSRF attacks to a form, one has to require a special token with the form, as follows:</p>
<ol>
<li><p>Для определенной формы генерируется случайная последовательность байт (токен)
и сохраняется на стороне сервера в данных PHP-сессии.</p>
</li>
<li><p>К форме добавляется скрытое поле, его значение задается токеном.</p>
</li>
<li><p>Когда пользователь отправляет форму, скрытое значение, переданное в форме,
сравнивается с токеном, сохраненном на стороне сервера. Если они совпадают,
данные формы считаются безопасными.</p>
</li>
</ol>
<blockquote class="notquote information" data-type="information"><p> Если вредоносный пользователь попробует атаковать сайт через отправку формы, 
 он не сможет поместить нужный токен в форму перед отправкой, так как токен
 не хранится в файлах cookie.</p>
</blockquote><h4 id="Пример__добавление_к_форме_элемента_CSRF">11.1.2.1. Пример: добавление к форме элемента CSRF</h4>
<p>В Zend Framework 3, чтобы добавить CSRF-защиту к модели формы,
используется класс элемента формы <code>Zend\Form\Element\Csrf</code>.</p>
<blockquote class="notquote information" data-type="information"><p> У элемента <code>Csrf</code> нет визуального представления (вы не увидите его на экране).</p>
</blockquote><p>Чтобы добавить элемент CSRF к модели формы, добавьте следующие строки в метод <code>addElements()</code>:</p>
<pre class="line-numbers"><code class="language-php">// Добавляем поле CSRF
$this-&gt;add([
  'type'  =&gt; 'csrf',
  'name' =&gt; 'csrf',
  'options' =&gt; [                
    'csrf_options' =&gt; [
      'timeout' =&gt; 600
    ]
  ],
]);
</code></pre>
<p>В этом фрагменте мы используем метод <code>add()</code> класса <code>Form</code> (строка 2), которому передается
описание элемента CSRF в виде массива. Элемент будет автоматически инстанцирован и инициализирован
фабрикой.</p>
<p>В строке 3 мы указываем имя класса для элемента CSRF. Это может быть либо полностью определенное
имя класса (<code>Zend\Form\Element\Csrf</code>), либо псевдоним ("csrf").</p>
<p>В строке 4 мы задаем атрибут "name" для элемента. В этом примере мы используем имя "csrf",
но вы можете использовать любое другое имя по вашему выбору.</p>
<p>В строке 6, внутри массива <code>csrf_options</code>, мы указываем опции для класса <code>Zend\Form\Element\Csrf</code>.
Мы задаем значение опции <code>timeout</code>, равное 600 (строка 7), что значит, срок действия CSRF-проверки
закончится спустя 600 секунд (10 минут) после создания формы.</p>
<p>Для визуализации поля CSRF добавьте следующую строку в файл шаблона представления <em>.phtml</em>:</p>
<pre class=""><code class="language-php">&lt;?= $this-&gt;formElement($form-&gt;get('csrf')); ?&gt;
</code></pre>
<p>Как только визуализатор PHP обработает шаблон представления, он сгенерирует HTML-разметку
для поля CSRF как показано ниже:</p>
<pre class=""><code class="language-text">&lt;input type="hidden" name="csrf" value="1bc42bd0da4800fb55d16e81136fe177"&gt; 
</code></pre>
<blockquote class="notquote tip" data-type="tip"><p> Как видите из кода разметки выше, форма теперь содержит скрытое поле со случайно
 сгенерированным токеном. Так как атакующий скрипт не знает этот токен, он не сможет
 отправить его корректное значение, тем самым CSRF-атака будет предотвращена.</p>
</blockquote><blockquote class="notquote question" data-type="question"><p> <strong>Что происходит при неудачной валидации элемента CSRF?</strong></p>
</blockquote><blockquote class="notquote question" data-type="question"><p> Если при валидации формы CSRF-проверка завершается неудачей, форма считается
 недействительной, и она будет снова показана пользователю для исправления ошибок,
 однако он не увидит сообщения об ошибке для элемента CSRF (мы не хотим, чтобы
 хакеры знали наверняка, что не так с формой). </p>
</blockquote>        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
﻿<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="WWATBCMWZJXS2">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/ru_RU/i/scr/pixel.gif" width="1" height="1">
</form>
</div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Продвинутое_использование_форм.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Продвинутое использование форм</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Продвинутое_использование_форм.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Продвинутое_использование_форм/Использование_групп_валидации.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright (c) 2017 by Oleg Krivtsov            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a>
            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

