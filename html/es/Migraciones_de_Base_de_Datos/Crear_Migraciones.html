<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free and open-source book about Zend Framework">
<meta name="keywords" content="php,zend framework,book,tutorial,documentation,learn,free">
<meta name="author" content="(c) 2018 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Crear Migraciones -- Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free and open-source book about Zend Framework            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Read</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Migraciones_de_Base_de_Datos/Configurar_las_Migraciones.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Migraciones_de_Base_de_Datos/Ejecutar_las_Migraciones.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Migraciones_de_Base_de_Datos.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Migraciones de Base de Datos</span>
        </a>
    </div>
    </div>

﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Book - Chapter - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="4531860323"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Chapter content -->
<div id="chapter_content">
<div class="incomplete-translation">
    Translation into this language is not yet finished. You can help this project 
    by translating the chapters and contributing your changes.
</div>

<h2 id="Crear_Migraciones">11.3. Crear Migraciones</h2>
<p>Una migración es un conjunto de cambios que actualizan o deshacen la actualización
en el esquema a su próximo o anterior estado respectivamente. Podemos generar
una migración nueva y vacía con la ayuda del siguiente comando:</p>
<pre class=""><code class="language-text">cd APP_DIR
./vendor/bin/doctrine-module migrations:generate
</code></pre>
<p>Los comandos de arriba nos mueven hasta el directorio de la aplicación estableciéndolo
como el directorio de trabajo y luego ejecuta el comando de consola <code>migrations:generate</code>.</p>
<blockquote class="notquote information" data-type="information"><p> <code>DoctrineModule</code> y <code>DoctrineORMModule</code> proveen varios comandos de consola
 que podemos usar para varias de las tareas de mantenimiento de la base de
 datos (como generar y ejecutar migraciones). Para ver una lista completa
 de los comandos disponibles podemos usar el comando <code>list</code>:</p>
<p> <code>./vendor/bin/doctrine-module list</code></p>
</blockquote><p>Una vez que ejecutemos el comando <code>migrations:generate</code> seremos capaces de
encontrar la migración creada recientemente dentro de la carpeta
<code>APP_DIR/data/Migrations</code>. El archivo tiene un nombre como
VersionYYYYMMDDHHIISS.php<code>, donde </code>YYYY<code> es el año, </code>MM<code> es el mes, </code>DD<code> es el día,
</code>HH<code>, </code>II<code> y </code>SS` representan respectivamente la hora, los minutos y los
segundos del momento de creación.</p>
<p>Si vemos el contenido del archivo creado recientemente encontraremos el siguiente
contenido:</p>
<pre class=""><code class="language-php">&lt;?php

namespace Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration;
use Doctrine\DBAL\Schema\Schema;

/**
 * Auto-generated Migration: Please modify to your needs!
 */
class Version20160901114333 extends AbstractMigration
{
    /**
     * @param Schema $schema
     */
    public function up(Schema $schema)
    {
        // this up() migration is auto-generated, please modify it to your needs

    }

    /**
     * @param Schema $schema
     */
    public function down(Schema $schema)
    {
        // this down() migration is auto-generated, please modify it to your needs

    }
}
</code></pre>
<blockquote class="notquote tip" data-type="tip"><p> Si no vemos la migración recién creada en el IDE NetBeans necesitaremos
 abrir el menú <em>Source</em> y hacer clic en el elemento del menú llamado
 <em>Scan for external changes</em>.</p>
</blockquote><p>Como podemos ver en el código de arriba una migración es una clase PHP normal
que hereda de la clase base <code>Doctrine\DBAL\Migrations\AbstractMigration</code>.
Cada migración deber tener <em>al menos</em> dos métodos: <code>up()</code> y <code>down()</code>.
El método <code>up()</code> actualiza el esquema al nuevo estado y el método <code>down()</code>
regresa el esquema a su estado anterior. Ambos métodos <code>up()</code> y <code>down()</code>
reciben solo un argumento de tipo <code>Doctrine\DBAL\Schema\Schema</code> que se pueden
usar para las modificaciones del esquema de base de datos actual.</p>
<blockquote class="notquote tip" data-type="tip"><p> La clase <code>Schema</code> es parte del componente <code>Doctrine\DBAL</code>. Para más información
 sobre los métodos que ella provee podemos revisar la documentación de
 Doctrine DBAL. Otra manera, que es incluso mejor, es revisar el código fuente
 que está dentro del directorio <code>vendor/doctrine/dbal</code>.</p>
</blockquote><p>Una clase de migración puede tener opcionalmente los siguientes métodos (sobrecargados)
(tabla 13.1):</p>
<div class="table-wrapper">
<div class="table-caption">Tabla 13.1. Métodos que una clase de migración puede tener</div><table>
<thead>
<tr>
<th> <em>Método</em>                       </th>
<th> <em>Descripción</em>                                                 </th>
</tr>
</thead>
<tbody>
<tr>
<td>  <code>isTransactional()</code>                                                                                                               </td>
<td>  Si la función regresa true (defecto) la migración se ejecutará  en una transacción de lo contrario un estado no transaccional   se usará para ejecutar cada una de las sentencias SQL de la     migración.                                                    </td>
</tr>
<tr>
<td> <code>getDescription()</code>                                              </td>
<td> Este método debería regresar una cadena de caracteres que       describe la migración (el propósito del cambio en el esquema) </td>
</tr>
<tr>
<td> <code>preUp(Schema $schema)</code>        </td>
<td> Este método se ejecutará antes de actualizar el esquema.      </td>
</tr>
<tr>
<td> <code>postUp(Schema $schema)</code>       </td>
<td> Este método se ejecutará después de actualizar el esquema.    </td>
</tr>
<tr>
<td> <code>preDown(Schema $schema)</code>                                       </td>
<td> Este método se ejecutará antes de deshacer una migración en el  esquema.                                                      </td>
</tr>
<tr>
<td> <code>postDown(Schema $schema)</code>                                      </td>
<td> Este método se ejecutará después de deshacer una migración en   el esquema.                                                   </td>
</tr>
</tbody>
</table>
</div>
<p>Además, la clase base <code>AbstractMigration</code> provee los siguientes métodos útiles
(tabla 13.2):</p>
<div class="table-wrapper">
<div class="table-caption">Tabla 13.2. Métodos provistos por la clase base `AbstractMigration`</div><table>
<thead>
<tr>
<th> <em>Método</em>                       </th>
<th> <em>Descripción</em>                                                 </th>
</tr>
</thead>
<tbody>
<tr>
<td> <code>addSql($sql, array $params = [], array $types = [])</code> </td>
<td> Este método permite ejecutar una       </td>
</tr>
</tbody>
</table>
</div>
<pre class=""><code class="language-text">                                                    | sentencia SQL arbitraria.              |
</code></pre>
<div class="table-wrapper">
<table>
<tbody>
<tr>
<td>  <code>write($message)</code>                                               </td>
<td>  Este método de ayuda imprime un mensaje en la pantalla          (un mensaje de detección de fallas o explicativo).            </td>
</tr>
<tr>
<td> <code>throwIrreversibleMigrationException($message = null)</code>                                                          </td>
<td> Este método de ayuda se usa generalmente dentro del método     <code>down()</code> para señalar que la migración no se puede deshacer. </td>
</tr>
</tbody>
</table>
</div>
<p>Como se ve en la tabla 13.2 se puede modificar el esquema llamando al método
<code>addSql()</code>. Este método se puede usar para crear una tabla, actualizar una tabla
o remover una tabla. Además, se puede usar para insertar algunos datos en la
tabla, aunque, insertar datos no es un cambio en el esquema.</p>
<blockquote class="notquote information" data-type="information"><p> Las migraciones de Doctrine se diseñaron para cambios en el esquema no para
 insertar datos en la base de datos. Sin embargo, insertar algunos datos iniciales
 es la base de datos es en ocasiones útil.</p>
</blockquote><p>Ahora que sabemos como crear migraciones vamos a crear un par de ellas para
nuestro <em>Blog</em> de ejemplo.</p>
<h3 id="Crear_la_Primera_Migración">11.3.1. Crear la Primera Migración</h3>
<p>La primera migración que crearemos es la migración inicial. Esta migración se
aplicará al esquema de base de datos vacío y creara las tablas: <code>post</code>, <code>comment</code>,
<code>tag</code> and <code>post_tag</code>.</p>
<p>Modificamos la clase de migración que hemos creado en la sección anterior para
que se vea como se muestra a continuación:</p>
<p>Modify the migration class we have created in the following section to look like below:</p>
<pre class=""><code class="language-php">&lt;?php

namespace Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration;
use Doctrine\DBAL\Schema\Schema;

/**
 * A migration class. It either upgrades the databases schema (moves it to new state)
 * or downgrades it to the previous state.
 */
class Version20160901114333 extends AbstractMigration
{
    /**
     * Returns the description of this migration.
     */
    public function getDescription()
    {
        $description = 'This is the initial migration which creates blog tables.';
        return $description;
    }

    /**
     * @param Schema $schema
     */
    public function up(Schema $schema)
    {
        // Create 'post' table
        $table = $schema-&gt;createTable('post');
        $table-&gt;addColumn('id', 'integer', ['autoincrement'=&gt;true]);
        $table-&gt;addColumn('title', 'text', ['notnull'=&gt;true]);
        $table-&gt;addColumn('content', 'text', ['notnull'=&gt;true]);
        $table-&gt;addColumn('status', 'integer', ['notnull'=&gt;true]);
        $table-&gt;addColumn('date_created', 'datetime', ['notnull'=&gt;true]);
        $table-&gt;setPrimaryKey(['id']);
        $table-&gt;addOption('engine' , 'InnoDB');

        // Create 'comment' table
        $table = $schema-&gt;createTable('comment');
        $table-&gt;addColumn('id', 'integer', ['autoincrement'=&gt;true]);
        $table-&gt;addColumn('post_id', 'integer', ['notnull'=&gt;true]);
        $table-&gt;addColumn('content', 'text', ['notnull'=&gt;true]);
        $table-&gt;addColumn('author', 'string', ['notnull'=&gt;true, 'lenght'=&gt;128]);
        $table-&gt;addColumn('date_created', 'datetime', ['notnull'=&gt;true]);
        $table-&gt;setPrimaryKey(['id']);
        $table-&gt;addOption('engine' , 'InnoDB');

        // Create 'tag' table
        $table = $schema-&gt;createTable('tag');
        $table-&gt;addColumn('id', 'integer', ['autoincrement'=&gt;true]);
        $table-&gt;addColumn('name', 'string', ['notnull'=&gt;true, 'lenght'=&gt;128]);
        $table-&gt;setPrimaryKey(['id']);
        $table-&gt;addOption('engine' , 'InnoDB');

        // Create 'post_tag' table
        $table = $schema-&gt;createTable('post_tag');
        $table-&gt;addColumn('id', 'integer', ['autoincrement'=&gt;true]);
        $table-&gt;addColumn('post_id', 'integer', ['notnull'=&gt;true]);
        $table-&gt;addColumn('tag_id', 'integer', ['notnull'=&gt;true]);
        $table-&gt;setPrimaryKey(['id']);
        $table-&gt;addOption('engine' , 'InnoDB');
    }

    /**
     * @param Schema $schema
     */
    public function down(Schema $schema)
    {
        $schema-&gt;dropTable('post_tag');
        $schema-&gt;dropTable('tag');
        $schema-&gt;dropTable('comment');
        $schema-&gt;dropTable('post');
    }
}
</code></pre>
<p>En el código de arriba tenemos tres métodos:</p>
<ul>
<li>El método <code>getDescription()</code> provee la descripción de la migración.</li>
<li>El método <code>up()</code> agrega algunas tablas actualizan el esquema a su nuevo estado.</li>
<li>El método <code>down()</code> borra las tablas deshaciendo la migración y llevando al
esquema a su estado anterior.</li>
</ul>
<h3 id="Agregar_otra_Migración">11.3.2. Agregar otra Migración</h3>
<p>Ahora supongamos que deseamos mejorar el rendimiento de nuestra base de datos
agregando indices a nuestras tablas.</p>
<blockquote class="notquote tip" data-type="tip"><p> Si queremos aprender sobre índices de base de datos con mayor profundidad
 y por que los son tan útiles, revisa este excelente tutorial
 <a href="http://use-the-index-luke.com/">El uso de los Indices, Luke</a>.</p>
</blockquote><p>Podemos mejorar la integridad de los datos agregando llaves foráneas. Para
hacer esto tenemos que agregar otra migración. Generamos otra migración con
el comando de consola <code>migrations:generate</code> y modificamos el código hasta que
quede de la siguiente manera:</p>
<pre class=""><code class="language-php">&lt;?php

namespace Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration;
use Doctrine\DBAL\Schema\Schema;

/**
 * A migration class. It either upgrades the databases schema (moves it to new state)
 * or downgrades it to the previous state.
 */
class Version20160901114938 extends AbstractMigration
{
    /**
     * Returns the description of this migration.
     */
    public function getDescription()
    {
        $description = 'This migration adds indexes and foreign key constraints.';
        return $description;
    }

    /**
     * @param Schema $schema
     */
    public function up(Schema $schema)
    {
        // Add index to post table
        $table = $schema-&gt;getTable('post');
        $table-&gt;addIndex(['date_created'], 'date_created_index');

        // Add index and foreign key to comment table
        $table = $schema-&gt;getTable('comment');
        $table-&gt;addIndex(['post_id'], 'post_id_index');
        $table-&gt;addForeignKeyConstraint('post', ['post_id'], ['id'], [], 'comment_post_id_fk');

        // Add indexes and foreign keys to post_tag table
        $table = $schema-&gt;getTable('post_tag');
        $table-&gt;addIndex(['post_id'], 'post_id_index');
        $table-&gt;addIndex(['tag_id'], 'tag_id_index');
        $table-&gt;addForeignKeyConstraint('post', ['post_id'], ['id'], [], 'post_tag_post_id_fk');
        $table-&gt;addForeignKeyConstraint('tag', ['tag_id'], ['id'], [], 'post_tag_tag_id_fk');
    }

    /**
     * @param Schema $schema
     */
    public function down(Schema $schema)
    {
        $table = $schema-&gt;getTable('post_tag');
        $table-&gt;removeForeignKey('post_tag_post_id_fk');
        $table-&gt;removeForeignKey('post_tag_tag_id_fk');
        $table-&gt;dropIndex('post_id_index');
        $table-&gt;dropIndex('tag_id_index');

        $table = $schema-&gt;getTable('comment');
        $table-&gt;dropIndex('post_id_index');
        $table-&gt;removeForeignKey('comment_post_id_fk');

        $table = $schema-&gt;getTable('post');
        $table-&gt;dropIndex('date_created_index');
    }
}
</code></pre>
<blockquote class="notquote tip" data-type="tip"><p> Podemos encontrar las migraciones que hemos creado en el ejemplo <em>Blog</em>
 que acompaña a este libro.</p>
</blockquote>        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Chapter - Bottom - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="1546211126"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Migraciones_de_Base_de_Datos.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Migraciones de Base de Datos</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Migraciones_de_Base_de_Datos/Configurar_las_Migraciones.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Migraciones_de_Base_de_Datos/Ejecutar_las_Migraciones.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright (c) 2018 by Oleg Krivtsov            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a>
            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>

<script src="../../assets/js/prism.js"></script>


<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

