<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free and open-source book about Zend Framework">
<meta name="keywords" content="php,zend framework,book,tutorial,documentation,learn,free">
<meta name="author" content="(c) 2018 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Implementing RbacManager -- Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free and open-source book about Zend Framework            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Read</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Role_Based_Access_Control/Assigning_Roles_to_a_User.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Role_Based_Access_Control/Adding_the_Not_Authorized_Page.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Role_Based_Access_Control.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Role-Based Access Control</span>
        </a>
    </div>
    </div>

﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Book - Chapter - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="4531860323"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Chapter content -->
<div id="chapter_content">

<h2 id="Implementing_RbacManager">17.10. Implementing RbacManager</h2>
<p>The next thing we will discuss will be the functionality for creating the <code>Rbac</code> container, 
whose purpose is loading the role hierarchy from the database,
and caching the data in the filesystem cache.</p>
<blockquote class="notquote information" data-type="information"><p> The <em>cache</em> allows to store frequently used data in fast storage. For example, retrieving roles
 and permissions from database on each page load may be rather slow, while storing the precomputed
 role hierarchy in a file may be faster. </p>
</blockquote><h3 id="Setting_Up_Caching">17.10.1. Setting Up Caching</h3>
<p>First, let's set up caching. To do that, you need to install the <code>Zend\Cache</code> and <code>Zend\Serializer</code> components with
the following commands:</p>
<pre class=""><code class="language-text">php composer.phar require zendframework/zend-cache
php composer.phar require zendframework/zend-serializer
</code></pre>
<p>Finally, edit the <em>config/autoload/global.php</em> and add the following lines:</p>
<pre class=""><code class="language-php">use Zend\Cache\Storage\Adapter\Filesystem;

return [
    //...
    // Cache configuration.
    'caches' =&gt; [
        'FilesystemCache' =&gt; [
            'adapter' =&gt; [
                'name'    =&gt; Filesystem::class,
                'options' =&gt; [
                    // Store cached data in this directory.
                    'cache_dir' =&gt; './data/cache',
                    // Store cached data for 1 hour.
                    'ttl' =&gt; 60*60*1 
                ],
            ],
            'plugins' =&gt; [
                [
                    'name' =&gt; 'serializer',
                    'options' =&gt; [                        
                    ],
                ],
            ],
        ],
    ],
    //...
];
</code></pre>
<p>This will allow you to use the <code>Filesystem</code> cache and store cached data
in <em>APP_DIR/data/cache</em> directory.</p>
<blockquote class="notquote tip" data-type="tip"><p> If you want to learn more about caching, please refer to the <code>Zend\Cache</code> ZF3 component
 documentation.</p>
</blockquote><h3 id="Writing_the_RbacManager_Service">17.10.2. Writing the RbacManager Service</h3>
<p>The purpose of the <code>RbacManager</code> service will be to construct the <code>Rbac</code> container and load
the roles and permissions from database. If the needed information is already saved to cache,
it will load it from cache instead of loading from database.</p>
<p>Another goal of the <code>RbacManager</code> service will be to use the assertion manager we wrote earlier
and check for dynamic assertions.</p>
<p>The <code>RbacManager</code> class will have two methods:</p>
<ul>
<li>the <code>init()</code> method will be used to load role hierarchy from database and save it in cache;</li>
<li>the <code>isGranted()</code> method will be used to query the <code>Rbac</code> container if the given <em>user</em> has the given permission
(and checking the assertion manager(s) for the dynamic assertions).</li>
</ul>
<p>The <code>RbacManager</code> class will read the configuration and look for the <code>rbac_manager</code> key.
The key should contain the <code>assertions</code> subkey, in which you can register all assertion managers that you have.</p>
<pre class=""><code class="language-php">return [
    //...
    
    // This key stores configuration for RBAC manager.
    'rbac_manager' =&gt; [
        'assertions' =&gt; [Service\RbacAssertionManager::class],
    ],
];
</code></pre>
<p>The code of the <code>RbacManager</code> class living in <code>User\Service</code> namespace is presented below. </p>
<pre class=""><code class="language-php">&lt;?php
namespace User\Service;

use Zend\Permissions\Rbac\Rbac;
use Zend\Permissions\Rbac\Role as RbacRole;
use User\Entity\User;
use User\Entity\Role;
use User\Entity\Permission;

/**
 * This service is responsible for initialzing RBAC (Role-Based Access Control).
 */
class RbacManager 
{
    /**
     * Doctrine entity manager.
     * @var Doctrine\ORM\EntityManager
     */
    private $entityManager; 
    
    /**
     * RBAC service.
     * @var Zend\Permissions\Rbac\Rbac
     */
    private $rbac;
    
    /**
     * Auth service.
     * @var Zend\Authentication\AuthenticationService 
     */
    private $authService;
    
    /**
     * Filesystem cache.
     * @var Zend\Cache\Storage\StorageInterface
     */
    private $cache;
    
    /**
     * Assertion managers.
     * @var array
     */
    private $assertionManagers = [];
    
    /**
     * Constructs the service.
     */
    public function __construct($entityManager, $authService, $cache, $assertionManagers) 
    {
        $this-&gt;entityManager = $entityManager;
        $this-&gt;authService = $authService;
        $this-&gt;cache = $cache;
        $this-&gt;assertionManagers = $assertionManagers;
    }
    
    /**
     * Initializes the RBAC container.
     */
    public function init($forceCreate = false)
    {
        if ($this-&gt;rbac!=null &amp;&amp; !$forceCreate) {
            // Already initialized; do nothing.
            return;
        }
        
        // If user wants us to reinit RBAC container, clear cache now.
        if ($forceCreate) {
            $this-&gt;cache-&gt;removeItem('rbac_container');
        }
        
        // Try to load Rbac container from cache.
        $this-&gt;rbac = $this-&gt;cache-&gt;getItem('rbac_container', $result);
        if (!$result)
        {
            // Create Rbac container.
            $rbac = new Rbac();
            $this-&gt;rbac = $rbac;

            // Construct role hierarchy by loading roles and permissions from database.

            $rbac-&gt;setCreateMissingRoles(true);

            $roles = $this-&gt;entityManager-&gt;getRepository(Role::class)
                    -&gt;findBy([], ['id'=&gt;'ASC']);
            foreach ($roles as $role) {

                $roleName = $role-&gt;getName();

                $parentRoleNames = [];
                foreach ($role-&gt;getParentRoles() as $parentRole) {
                    $parentRoleNames[] = $parentRole-&gt;getName();
                }

                $rbac-&gt;addRole($roleName, $parentRoleNames);

                foreach ($role-&gt;getPermissions() as $permission) {
                    $rbac-&gt;getRole($roleName)-&gt;addPermission($permission-&gt;getName());
                }
            }
            
            // Save Rbac container to cache.
            $this-&gt;cache-&gt;setItem('rbac_container', $rbac);
        }
    }
    
    /**
     * Checks whether the given user has permission.
     * @param User|null $user
     * @param string $permission
     * @param array|null $params
     */
    public function isGranted($user, $permission, $params = null)
    {
        if ($this-&gt;rbac==null) {
            $this-&gt;init();
        }
        
        if ($user==null) {
            
            $identity = $this-&gt;authService-&gt;getIdentity();
            if ($identity==null) {
                return false;
            }
            
            $user = $this-&gt;entityManager-&gt;getRepository(User::class)
                    -&gt;findOneByEmail($identity);
            if ($user==null) {
                // Oops.. the identity presents in session, but there is no such user in database.
                // We throw an exception, because this is a possible security problem.
                throw new \Exception('There is no user with such identity');
            }
        }
        
        $roles = $user-&gt;getRoles();
        
        foreach ($roles as $role) {
            if ($this-&gt;rbac-&gt;isGranted($role-&gt;getName(), $permission)) {
                
                if ($params==null)
                    return true;
                    
                foreach ($this-&gt;assertionManagers as $assertionManager) {
                    if ($assertionManager-&gt;assert($this-&gt;rbac, $permission, $params))
                        return true;
                }
                
                return false;
            }
        }
        
        return false;
    }
}
</code></pre>
<p>The factory for the <code>RbacManager</code> class looks like the following:</p>
<pre class=""><code class="language-php">&lt;?php
namespace User\Service\Factory;

use Interop\Container\ContainerInterface;
use User\Service\RbacManager;
use Zend\Authentication\AuthenticationService;

/**
 * This is the factory class for RbacManager service. The purpose of the factory
 * is to instantiate the service and pass it dependencies (inject dependencies).
 */
class RbacManagerFactory
{
    /**
     * This method creates the RbacManager service and returns its instance. 
     */
    public function __invoke(ContainerInterface $container, $requestedName, array $options = null)
    {        
        $entityManager = $container-&gt;get('doctrine.entitymanager.orm_default');
        $authService = $container-&gt;get(\Zend\Authentication\AuthenticationService::class);
        $cache = $container-&gt;get('FilesystemCache');
        
        $assertionManagers = [];
        $config = $container-&gt;get('Config');
        if (isset($config['rbac_manager']['assertions'])) {
            foreach ($config['rbac_manager']['assertions'] as $serviceName) {
                $assertionManagers[$serviceName] = $container-&gt;get($serviceName);
            }
        }
        
        return new RbacManager($entityManager, $authService, $cache, $assertionManagers);
    }
}
</code></pre>
        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Chapter - Bottom - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="1546211126"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Role_Based_Access_Control.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Role-Based Access Control</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Role_Based_Access_Control/Assigning_Roles_to_a_User.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Role_Based_Access_Control/Adding_the_Not_Authorized_Page.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright (c) 2018 by Oleg Krivtsov            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a>
            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

