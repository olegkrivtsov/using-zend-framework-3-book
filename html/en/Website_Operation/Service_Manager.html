<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free and open-source book about Zend Framework">
<meta name="keywords" content="php,zend framework,book,tutorial,documentation,learn,free">
<meta name="author" content="(c) 2016 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Service Manager -- Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free and open-source book about Zend Framework            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Read</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Website_Operation/Module_Entry_Point.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Website_Operation/Summary.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Website_Operation.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Website Operation</span>
        </a>
    </div>
    </div>

﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Book - Chapter - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="4531860323"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Chapter content -->
<div id="chapter_content">

<h2 id="header-61">3.9. Service Manager</h2>
<p>You can imagine the web application as a set of <em>services</em>. For example,
you can have an authentication service responsible for logging in the site users, 
entity manager service responsible for accessing the database, event manager service 
responsible for triggering events and delivering them to event listeners, etc.</p>
<p>In Zend Framework, the <code>ServiceManager</code> class is a centralized repository for all 
application services. The service manager is implemented in <code>Zend\ServiceManager</code> 
component, as the <code>ServiceManager</code> class. </p>
<p>The service manager is created on application start up (inside of <code>init()</code>
static method of <code>Zend\Mvc\Application</code> class).
The standard services available through service manager are presented in table 3.1. 
This table is incomplete, because the actual number of services registered in service manager 
may be much bigger.</p>
<div class="table-wrapper">
<div class="table-caption">Table 3.1. Standard services</div><table>
<thead>
<tr>
<th> Service Name         </th>
<th> Description                                                           </th>
</tr>
</thead>
<tbody>
<tr>
<td>  Application          </td>
<td>  Allows to retrieve the singleton of <code>Zend\Mvc\Application</code> class.     </td>
</tr>
<tr>
<td> ApplicationConfig    </td>
<td> Configuration array extracted from <em>application.config.php</em> file.     </td>
</tr>
<tr>
<td> Config                                      </td>
<td> Merged configuration array extracted from <em>module.config.php</em> files     merged with <em>autoload/global.php</em> and <em>autoload/local.php</em>.           </td>
</tr>
<tr>
<td> EventManager                                </td>
<td> Allows to retrieve the singleton of <code>Zend\Mvc\EventManager</code> class. The    event manager allows to send (trigger) events and attach event listeners. </td>
</tr>
<tr>
<td> ModuleManager                               </td>
<td> Allows to retrieve the singleton of <code>Zend\Mvc\ModuleManager</code> class. The   module manager is responsible for loading application modules.        </td>
</tr>
<tr>
<td> Request                                     </td>
<td> The singleton of <code>Zend\Http\Request</code> class. Represents HTTP request     received from client.                                                 </td>
</tr>
<tr>
<td> Response                                    </td>
<td> The singleton of <code>Zend\Http\Response</code> class. Represents HTTP response that    will be sent to client.                                               </td>
</tr>
<tr>
<td> Router               </td>
<td> The singleton of <code>Zend\Router\Http\TreeRouteStack</code>. Performs URL routing. </td>
</tr>
<tr>
<td> ServiceManager       </td>
<td> Service manager itself.                                               </td>
</tr>
<tr>
<td> ViewManager                                 </td>
<td> The singleton of <code>Zend\Mvc\View\Http\ViewManager</code> class. Responsible for      preparing the view layer for page rendering.                               </td>
</tr>
</tbody>
</table>
</div>
<p>A service is typically an arbitrary PHP class, but not always. For example, when ZF3
loads the configuration files and merges the data into nested arrays, it saves the arrays 
in the service manager as a couple of services (!): <code>ApplicationConfig</code> and <code>Config</code>. 
The first one is the array loaded from application-level configuration file <em>application.config.php</em>,
and the later one is the merged array from module-level config files and auto-loaded 
application-level config files. Thus, in the service manager you can store any asset 
you want: a PHP class, a variable or an array.</p>
<p>From table 3.1, you can see that in ZF3 everything can be considered as a service. The service 
manager is itself registered as a service. Moreover, the <code>Application</code> class is also 
registered as a service.  </p>
<blockquote class="notquote information" data-type="information"><p> An important thing you should note about the services is that they are typically 
 stored in a single instance only (this is also called the <em>singleton</em> pattern). Obviously,
 you don't need the second instance of the <code>Application</code> class or, say, the event manager (in that case you
 would have a nightmare). </p>
</blockquote><p>The service manager defines the methods needed for locating and retrieving 
a service from the service manager:</p>
<pre class=""><code class="language-php">// Retrieves a registered service's instance.
public function get($name);

// Checks if such a service is registered.
public function has($name);
</code></pre>
<p>You can test if a service is registered by passing its name to the service manager's 
<code>has()</code> method. It returns a boolean <code>true</code> if the service is registered, or
<code>false</code> if the service with such a name is not registered.</p>
<p>You can retrieve a service by its name at any place of your 
application with the help of the service manager's <code>get()</code> method. This method
takes a single parameter representing the service name. Look at the following
example:</p>
<pre class=""><code class="language-php">&lt;?php 

// Retrieve the application config array.
$appConfig = $serviceManager-&gt;get('ApplicationConfig');

// Use it (for example, retrieve the module list).
$modules = $appConfig['modules'];
</code></pre>
<h3 id="header-62">3.9.1. Service Names</h3>
<p>Different services can use different naming styles. For example, the same currency converter service 
may be registered under the different names: <code>CurrencyConverter</code>,  <code>currency_converter</code> 
and so on. To introduce some uniform naming convention, it is recommended to register a service by
its fully qualified class name, as follows:</p>
<pre class=""><code class="language-text">$serviceManager-&gt;setService(CurrencyConverter::class);
</code></pre>
<p>In the example above, we used the keyword <code>class</code>. It is available since PHP 5.5 and is used for class 
name resolution. <code>CurrencyConverter::class</code> is expanded to the fully qualified name of the class, 
like <code>\Application\Service\CurrencyConverter</code>.</p>
<h3 id="header-63">3.9.2. Registering a Service</h3>
<p>When writing your website, sometimes you will need to register your custom service
in the service manager. To register a service, you use the <code>setService()</code> method.
Let's create and register the currency converter service class, which
will be used, for example, on a shopping cart page to convert EUR currency to USD:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php 
// Define a namespace where our custom service lives.
namespace Application\Service;

// Define a currency converter service class.
class CurrencyConverter 
{
  // Converts euros to US dollars.
  public function convertEURtoUSD($amount) 
  {
    return $amount*1.25;
  }
	
  //...
}
</code></pre>
<p>Above, in lines 6-15 we define an example <code>CurrencyConverter</code> class (for simplicity, we implement
only a single method <code>convertEURtoUSD()</code> which is able to convert euros to US dollars).</p>
<pre class=""><code class="language-php">// Create an instance of the class.
$service = new CurrencyConverter();
// Save the instance to service manager.
$serviceManager-&gt;setService(CurrencyConverter::class, $service);
</code></pre>
<p>In the example above, we instantiate the class with the <code>new</code> operator, and register it
with the service manager using the <code>setService()</code> method (we assume that the <code>$serviceManager</code> variable
is of type <code>Zend\ServiceManager\ServiceManager</code> class, and that it was declared somewhere else). </p>
<p>The <code>setService()</code> method takes two parameters: the service name string, and the service instance.
The service name should be unique within all other possible services. If you are trying to register
the service name which is already present, the <code>setService()</code> method will throw an exception. But sometimes
you want to override the service with the same name (to replace it by the new one). For this purpose,
you can use the <code>setAllowOverride()</code> method of the service manager:</p>
<pre class=""><code class="language-php">&lt;?php 
// Allow to replace services 
$serviceManager-&gt;setAllowOverride(true);

// Save the instance to service manager. There will be no exception
// even if there is another service with such a name.
$serviceManager-&gt;setService(CurrencyConverter::class, $service);
</code></pre>
<p>Above, the <code>setAllowOverride()</code> method takes the single boolean parameter defining whether
to allow you replace the service <code>CurrencyConverter</code> if such a name is already present, or not.</p>
<p>Once the service is stored in service manager, you can retrieve it by name at any place of your 
application with the help of the service manager's <code>get()</code> method. Look at the following
example:</p>
<pre class=""><code class="language-php">&lt;?php 
// Retrieve the currency converter service.
$service = $serviceManager-&gt;get(CurrencyConverter::class);

// Use it (convert money amount).
$convertedAmount = $service-&gt;convertEURtoUSD(50);
</code></pre>
<h3 id="header-64">3.9.3. Registering Invokable Classes</h3>
<p>What is bad with the <code>setService()</code> method is that you have to create the service instance
before you really need it. If you never use the service, the service instantiation will only
waste the time and memory. To resolve this issue, the service manager provides you with the 
<code>setInvokableClass()</code> method.</p>
<pre class=""><code class="language-php">&lt;?php 
// Register an invokable class
$serviceManager-&gt;setInvokableClass(CurrencyConverter::class);
</code></pre>
<p>In the example above, we pass to the service manager the fully qualified class name of
the service instead of passing its instance. With this technique, the service
will be instantiated by the service manager only when someone calls the <code>get(CurrencyConverter::class)</code>
method. This is also called lazy loading.</p>
<h3 id="header-65">3.9.4. Registering Factories</h3>
<p>Sometimes, service instantiation is more complex than just creating the service instance
with <code>new</code> operator. You may need to pass some parameters to the service's constructor or
invoke some service methods just after construction. This complex instantiation logics
can be encapsulated inside of a <em>factory</em>. A factory is a PHP class responsible for creating
new objects. The factory class typically implements the <code>FactoryInterface</code>:</p>
<pre class=""><code class="language-php">&lt;?php
namespace Zend\ServiceManager\Factory;

use Interop\Container\ContainerInterface;

interface FactoryInterface
{
    public function __invoke(ContainerInterface $container, 
                        $requestedName, array $options = null);
}
</code></pre>
<p>As we see from the definition of the <code>FactoryInterface</code>, the factory class must provide
the <code>__invoke</code> magic method returning the instance of a single service. The service manager is
passed to the <code>__invoke</code> method as the <code>$container</code> parameter; it can be used during the construction of 
the service for accessing other services (to inject <em>dependencies</em>).</p>
<p>As an example, let's write a factory for our currency converter service (see the code below). 
We don't use complex construction logics for our <code>CurrencyConverter</code> service, but for more complex 
services, you may need to use one.</p>
<pre class=""><code class="language-php">&lt;?php 
use Zend\ServiceManager\Factory\FactoryInterface;
use Application\Service\CurrencyConverter;

// Factory class
class CurrencyConverterFactory implements FactoryInterface
{
  public function __invoke(ContainerInterface $container, 
                     $requestedName, array $options = null) 
  {
    // Create an instance of the class.
    $service = new CurrencyConverter();	
	
    return $service;
  }
}
</code></pre>
<p>Even more complex case of a factory is when you need to determine at run
time which services should be registered, and which should not. For such a situation,
you can use an <em>abstract factory</em>. An abstract factory class should
implement the <code>AbstractFactoryInterface</code> interface:</p>
<pre class=""><code class="language-php">&lt;?php 
namespace Zend\ServiceManager\Factory;

use Interop\Container\ContainerInterface;

interface AbstractFactoryInterface extends FactoryInterface
{
    public function canCreate(ContainerInterface $container, $requestedName);
}
</code></pre>
<p>The <code>AbstractFactoryInterface</code> interface has two methods: <code>canCreate()</code>
and <code>__invoke()</code>. The first one is needed to test if the factory can
create the service with the certain name, and the latter one allows to actually
create the service. The methods take two parameters: service manager and
service name.</p>
<p>Comparing to usual factory class, the difference is that the
usual factory class can create only a single service, but an abstract factory can dynamically 
create as many services as it wants.</p>
<h3 id="header-66">3.9.5. Registering Service Aliases</h3>
<p>Sometimes, you may want to define an <em>alias</em> for a service. The alias 
is like a symbolic link: it references the already registered service.
To create an alias, you use the service manager's <code>setAlias()</code> method:</p>
<pre class=""><code class="language-php">&lt;?php 
// Register an alias for the CurrencyConverter service
$serviceManager-&gt;setAlias('CurConv', CurrencyConverter::class);
</code></pre>
<p>Once registered, you can retrieve the service by both its name and alias using the 
service manager's <code>get()</code> method.</p>
<h3 id="header-67">3.9.6. Service Manager Configuration</h3>
<p>To automatically register a service within the service manager, typically the
<code>service_manager</code> key of a configuration file is used. You can put this key
either inside of an application-level configuration file or in a module-level 
configuration file. </p>
<blockquote class="notquote warning" data-type="warning"><p> If you are putting this key in a module-level configuration file, be
 careful about the danger of name overwriting during the configs merge.
 Do not register the same service name in different modules.</p>
</blockquote><p>This <code>service_manager</code> key should look like below:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php 
return [
  //...

  // Register the services under this key
  'service_manager' =&gt; [
    'services' =&gt; [
      // Register service class instances here
      //...
    ],
    'invokables' =&gt; [
      // Register invokable classes here
      //...
    ],
    'factories' =&gt; [
      // Register factories here
      //...
    ],
    'abstract_factories' =&gt; [
      // Register abstract factories here
      //...
    ],
    'aliases' =&gt; [
      // Register service aliases here
      //...
    ],
  ],
  
  //...
];
</code></pre>
<p>In the example above, you can see that the <code>service_manager</code> key may contain several
subkeys for registering services in different ways:</p>
<ul>
<li>the <code>services</code> subkey (line 7) allows to register class instances;</li>
<li>the <code>invokables</code> subkey (line 11) allows to register full class name of a service;
the service will be instantiated using lazy loading;</li>
<li>the <code>factories</code> subkey (line 15) allows for registering a factory, which is able
to create instances of a single service;</li>
<li>the <code>abstract_factories</code> (line 19) can be used for registering abstract factories,
which are able to register several services by name;</li>
<li>the <code>aliases</code> subkey (line 23) provides an ability to register an alias for a service.</li>
</ul>
        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Chapter - Bottom - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="1546211126"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Website_Operation.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Website Operation</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Website_Operation/Module_Entry_Point.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Website_Operation/Summary.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright (c) 2016 by Oleg Krivtsov            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a> on 2016-09-03 at 20:13            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

