<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free and open-source book about Zend Framework">
<meta name="keywords" content="php,zend framework,book,tutorial,documentation,learn,free">
<meta name="author" content="(c) 2016 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Creating Migrations -- Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free and open-source book about Zend Framework            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Read</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Database_Migrations/Configuring_Migrations.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Database_Migrations/Executing_Migrations.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Database_Migrations.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Database Migrations</span>
        </a>
    </div>
    </div>

﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Book - Chapter - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="4531860323"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Chapter content -->
<div id="chapter_content">

<h2 id="header-327">13.3. Creating Migrations</h2>
<p>A migration is a change set upgrading or downgrading the schema to its next or previous state, respectively.
You generate a new empty migration with the help of the following commands:</p>
<pre class=""><code class="language-text">cd APP_DIR
./vendor/bin/doctrine-module migrations:generate
</code></pre>
<p>The commands above make the application directory the current working directory and then 
run the <code>migrations:generate</code> console command.</p>
<blockquote class="notquote information" data-type="information"><p> <code>DoctrineModule</code> and <code>DoctrineORMModule</code> provide several console commands that you can use for various
 database maintenance tasks (like generating or executing migrations). For the list of available commands,
 you can use the <code>list</code> command:</p>
<p> <code>./vendor/bin/doctrine-module list</code></p>
</blockquote><p>Once you run the <code>migrations:generate</code> command, you will be able to find the newly created migration under the <code>APP_DIR/data/Migrations</code> directory.
The file has a name like <code>VersionYYYYMMDDHHIISS.php</code>, where <code>YYYY</code> is current year, <code>MM</code> is current month, <code>DD</code> is current day,
<code>HH</code>, <code>II</code> and <code>SS</code> represent current hour, minute and second, respectively.</p>
<p>If you look into the newly created file, you will find the following content:</p>
<pre class=""><code class="language-php">&lt;?php

namespace Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration;
use Doctrine\DBAL\Schema\Schema;

/**
 * Auto-generated Migration: Please modify to your needs!
 */
class Version20160901114333 extends AbstractMigration
{
    /**
     * @param Schema $schema
     */
    public function up(Schema $schema)
    {
        // this up() migration is auto-generated, please modify it to your needs

    }

    /**
     * @param Schema $schema
     */
    public function down(Schema $schema)
    {
        // this down() migration is auto-generated, please modify it to your needs

    }
}
</code></pre>
<blockquote class="notquote tip" data-type="tip"><p> If you do not see the newly created migration in NetBeans IDE, you need to open the menu <em>Source</em> and select the 
 <em>Scan for external changes</em> menu item.</p>
</blockquote><p>As you can see from the code above, a migration is a usual PHP class inherited from <code>Doctrine\DBAL\Migrations\AbstractMigration</code>
base class. Every migration should have <em>at least</em> two methods: <code>up()</code> and <code>down()</code>. The <code>up()</code> method upgrades the schema to a newer state,
the <code>down()</code> method downgrades the schema from its newer state to the previous state. Both <code>up()</code> and <code>down()</code> methods have a single
argument of type <code>Doctrine\DBAL\Schema\Schema</code>, which can be used for actual database schema modifications. </p>
<blockquote class="notquote tip" data-type="tip"><p> The <code>Schema</code> class is a part of <code>Doctrine\DBAL</code> component. For more information about the methods it provides, please
 refer to Doctrine DBAL documentation. Another, even better way is to look at the code inside your <code>vendor/doctrine/dbal</code> directory.</p>
</blockquote><p>A migration class may optionally have the following (overriden) methods (table 13.1):</p>
<div class="table-wrapper">
<div class="table-caption">Table 13.1. Methods a migration class may have</div><table>
<thead>
<tr>
<th> <em>Method</em>                       </th>
<th> <em>Description</em>                                                 </th>
</tr>
</thead>
<tbody>
<tr>
<td>  <code>isTransactional()</code>                                             </td>
<td>  If this function returns true (default) the migration will be executed in one transaction,   otherwise non-transactional state will be used to execute each of the migration SQLs.</td>
</tr>
<tr>
<td> <code>getDescription()</code>             </td>
<td> This method should return a string describing the migration (for what purpose this schema change is done) </td>
</tr>
<tr>
<td> <code>preUp(Schema $schema)</code>        </td>
<td> This method will be executed before upgrading the schema.     </td>
</tr>
<tr>
<td> <code>postUp(Schema $schema)</code>       </td>
<td> This method will be executed after upgrading the schema.      </td>
</tr>
<tr>
<td> <code>preDown(Schema $schema)</code>      </td>
<td> This method will be executed before downgrading the schema.     </td>
</tr>
<tr>
<td> <code>postDown(Schema $schema)</code>     </td>
<td> This method will be executed after downgrading the schema.      </td>
</tr>
</tbody>
</table>
</div>
<p>The <code>AbstractMigration</code> base class also provides the following useful methods (table 13.2):</p>
<div class="table-wrapper">
<div class="table-caption">Table 13.2. Methods provided by the base migration class</div><table>
<thead>
<tr>
<th> <em>Method</em>                       </th>
<th> <em>Description</em>                                                 </th>
</tr>
</thead>
<tbody>
<tr>
<td>  <code>addSql($sql, array $params = [], array $types = [])</code> </td>
<td>  This method allows to execute an arbitrary SQL request. </td>
</tr>
<tr>
<td> <code>write($message)</code>              </td>
<td> This helper method prints a (debug or explanatory) message to screen. </td>
</tr>
<tr>
<td> <code>throwIrreversibleMigrationException($message = null)</code> </td>
<td> This helper method is typically called inside of <code>down()</code> method to signal that the migration cannot be undone. </td>
</tr>
</tbody>
</table>
</div>
<p>As you can see from table 13.2, you can also modify the schema by calling <code>addSql()</code> method. This method
can be used to create a table, to update a table or to remove a table. It can also be used, for example, to insert
some data to a table (however, inserting data is not a schema change).</p>
<blockquote class="notquote information" data-type="information"><p> Doctrine migrations are designed for schema changes, not for inserting data to the database. Although,
 inserting some initial data to database is useful in some cases. </p>
</blockquote><p>Now that you know how to create a migration, let's create a couple of migrations for our <em>Blog</em> sample.</p>
<h3 id="header-328">13.3.1. Creating the Initial Migration</h3>
<p>The first migration we will create is the initial migration. This migration will be applied to empty database
schema and will create four tables: <code>post</code>, <code>comment</code>, <code>tag</code> and <code>post_tag</code>.</p>
<p>Modify the migration class we have created in the following section to look like below:</p>
<pre class=""><code class="language-php">&lt;?php

namespace Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration;
use Doctrine\DBAL\Schema\Schema;

/**
 * A migration class. It either upgrades the databases schema (moves it to new state)
 * or downgrades it to the previous state.
 */
class Version20160901114333 extends AbstractMigration
{
    /**
     * Returns the description of this migration.
     */
    public function getDescription()
    {
        $description = 'This is the initial migration which creates blog tables.';
        return $description;
    }
    
    /**
     * @param Schema $schema
     */
    public function up(Schema $schema)
    {
        // Create 'post' table
        $table = $schema-&gt;createTable('post');
        $table-&gt;addColumn('id', 'integer', ['autoincrement'=&gt;true]);        
        $table-&gt;addColumn('title', 'text', ['notnull'=&gt;true]);
        $table-&gt;addColumn('content', 'text', ['notnull'=&gt;true]);
        $table-&gt;addColumn('status', 'integer', ['notnull'=&gt;true]);
        $table-&gt;addColumn('date_created', 'datetime', ['notnull'=&gt;true]);
        $table-&gt;setPrimaryKey(['id']);
        $table-&gt;addOption('engine' , 'InnoDB');
        
        // Create 'comment' table
        $table = $schema-&gt;createTable('comment');
        $table-&gt;addColumn('id', 'integer', ['autoincrement'=&gt;true]); 
        $table-&gt;addColumn('post_id', 'integer', ['notnull'=&gt;true]);
        $table-&gt;addColumn('content', 'text', ['notnull'=&gt;true]);
        $table-&gt;addColumn('author', 'string', ['notnull'=&gt;true, 'lenght'=&gt;128]);
        $table-&gt;addColumn('date_created', 'datetime', ['notnull'=&gt;true]);
        $table-&gt;setPrimaryKey(['id']);
        $table-&gt;addOption('engine' , 'InnoDB');
        
        // Create 'tag' table
        $table = $schema-&gt;createTable('tag');
        $table-&gt;addColumn('id', 'integer', ['autoincrement'=&gt;true]); 
        $table-&gt;addColumn('name', 'string', ['notnull'=&gt;true, 'lenght'=&gt;128]);
        $table-&gt;setPrimaryKey(['id']);
        $table-&gt;addOption('engine' , 'InnoDB');
        
        // Create 'post_tag' table
        $table = $schema-&gt;createTable('post_tag');
        $table-&gt;addColumn('id', 'integer', ['autoincrement'=&gt;true]); 
        $table-&gt;addColumn('post_id', 'integer', ['notnull'=&gt;true]);
        $table-&gt;addColumn('tag_id', 'integer', ['notnull'=&gt;true]);
        $table-&gt;setPrimaryKey(['id']);
        $table-&gt;addOption('engine' , 'InnoDB');       
    }

    /**
     * @param Schema $schema
     */
    public function down(Schema $schema)
    {
        $schema-&gt;dropTable('post_tag');
        $schema-&gt;dropTable('tag');
        $schema-&gt;dropTable('comment');
        $schema-&gt;dropTable('post');
    }
}
</code></pre>
<p>In the code above we have three methods: </p>
<ul>
<li>the <code>getDescription()</code> method provides the description of the migration.</li>
<li>the <code>up()</code> method upgrades the schema to its newer state by adding new tables.</li>
<li>the <code>down()</code> method drops tables thus downgrading the schema to its previous state.</li>
</ul>
<h3 id="header-329">13.3.2. Adding Another Migration</h3>
<p>Now assume we decided to improve the performance of our database by adding indexes to our tables. We can also 
improve data integrity by adding foreign keys. To do this, we have to add another migration. Generate another
empty migration with the <code>migrations:generate</code> console command. Modify the code to look like below:</p>
<pre class=""><code class="language-php">&lt;?php

namespace Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration;
use Doctrine\DBAL\Schema\Schema;

/**
 * A migration class. It either upgrades the databases schema (moves it to new state)
 * or downgrades it to the previous state.
 */
class Version20160901114938 extends AbstractMigration
{
    /**
     * Returns the description of this migration.
     */
    public function getDescription()
    {
        $description = 'This migration adds indexes and foreign key constraints.';
        return $description;
    }
    
    /**
     * @param Schema $schema
     */
    public function up(Schema $schema)
    {
        // Add index to post table
        $table = $schema-&gt;getTable('post');
        $table-&gt;addIndex(['date_created'], 'date_created_index');
        
        // Add index and foreign key to comment table
        $table = $schema-&gt;getTable('comment');
        $table-&gt;addIndex(['post_id'], 'post_id_index');
        $table-&gt;addForeignKeyConstraint('post', ['post_id'], ['id'], [], 'comment_post_id_fk');
        
        // Add indexes and foreign keys to post_tag table
        $table = $schema-&gt;getTable('post_tag');
        $table-&gt;addIndex(['post_id'], 'post_id_index');
        $table-&gt;addIndex(['tag_id'], 'tag_id_index');
        $table-&gt;addForeignKeyConstraint('post', ['post_id'], ['id'], [], 'post_tag_post_id_fk');
        $table-&gt;addForeignKeyConstraint('tag', ['tag_id'], ['id'], [], 'post_tag_tag_id_fk');
    }

    /**
     * @param Schema $schema
     */
    public function down(Schema $schema)
    {
        $table = $schema-&gt;getTable('post_tag');
        $table-&gt;removeForeignKey('post_tag_post_id_fk');
        $table-&gt;removeForeignKey('post_tag_tag_id_fk');
        $table-&gt;dropIndex('post_id_index');
        $table-&gt;dropIndex('tag_id_index'); 
        
        $table = $schema-&gt;getTable('comment');
        $table-&gt;dropIndex('post_id_index'); 
        $table-&gt;removeForeignKey('comment_post_id_fk');
        
        $table = $schema-&gt;getTable('post');
        $table-&gt;dropIndex('date_created_index');       
    }
}
</code></pre>
<blockquote class="notquote tip" data-type="tip"><p> You can find the migrations we have just created inside of the <em>Blog</em> sample bundled with this book.</p>
</blockquote>        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Chapter - Bottom - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="1546211126"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Database_Migrations.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Database Migrations</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Database_Migrations/Configuring_Migrations.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Database_Migrations/Executing_Migrations.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright (c) 2016 by Oleg Krivtsov            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a> on 2016-09-12 at 06:17            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

