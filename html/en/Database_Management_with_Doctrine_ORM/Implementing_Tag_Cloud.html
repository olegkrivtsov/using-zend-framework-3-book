<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free and open-source book about Zend Framework">
<meta name="keywords" content="php,zend framework,book,tutorial,documentation,learn,free">
<meta name="author" content="(c) 2016 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Implementing Tag Cloud -- Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free and open-source book about Zend Framework            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Read</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Database_Management_with_Doctrine_ORM/Implementing_Admin_Page.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Database_Management_with_Doctrine_ORM/Summary.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Database_Management_with_Doctrine_ORM.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Database Management with Doctrine ORM</span>
        </a>
    </div>
    </div>

﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Book - Chapter - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="4531860323"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Chapter content -->
<div id="chapter_content">

<h2 id="header-319">12.14. Implementing Tag Cloud</h2>
<p>The last feature we implement in the <em>Blog</em> sample will be the tag cloud. The tag cloud appears on 
the <em>Home</em> page. The tag cloud contains most popular tags, and tag's font size varies depending on 
popularity of the tag: most popular tags appear larger than less popular ones. Clicking the tag in 
the tag cloud results in filtering posts by this tag.</p>
<p>For example of what we are trying to achieve, please look at the right side of the figure 12.11 below:</p>
<p><span class="image-wrapper">
<a target="_blank" href="../images/doctrine/tag_cloud.png">
<img src="../images/doctrine/tag_cloud.png" alt="Figure 12.11. Tag cloud" /></a>
<span class="image-caption">Figure 12.11. Tag cloud</span>
</span>
  </p>
<p>For this feature, we need the following things:</p>
<ul>
<li>to create the <code>PostRepository</code> custom entity repository class that would encapsulate the complex logic 
of filtering posts by tag;</li>
<li>to modify the <code>PostManager</code> and add functionality for calculating font sizes for the tag cloud;</li>
<li>to add controller's action and corresponding view template.</li>
</ul>
<h3 id="header-320">12.14.1. Adding Custom Post Repository</h3>
<p>Earlier we mentioned that by default Doctrine uses the <code>Doctrine\ORM\EntityRepository</code> as the 
default repository class. Custom repository is a class extended from <code>EntityRepository</code> class. 
It is typically used when you need to encapsulate complex DQL queries and search logic in a single place in your code. </p>
<blockquote class="notquote information" data-type="information"><p> It is also possible to put the DQL queries to controller class, but that would make controllers "fat".
   Since we use MVC pattern, we strive to avoid that.</p>
</blockquote><blockquote class="notquote information" data-type="information"><p> DQL is similar to SQL in sense that it allows to write and execute queries to database, but the result 
   of a query is an array of objects rather than an array of table rows. For more information on DQL
   and its usage examples, please refer to this <a href="http://docs.doctrine-project.org/en/latest/reference/dql-doctrine-query-language.html">page</a>.</p>
</blockquote><p>For our <em>Blog</em> sample web application, we need a custom repository which allows to find published
posts having at least one tag (to calculate total count of tagged posts), and, to find published 
posts filtered by particular tag. We plan to encapsulate this search logic into the custom <code>PostRepository</code> repository. </p>
<blockquote class="notquote information" data-type="information"><p> Doctrine works with custom repositories transparently. This means, that you retrieve the repository
   from <code>EntityManager</code> as usual and still can use its <code>findBy()</code>, <code>findOneBy()</code> and other methods.</p>
</blockquote><p>Create the <em>PostRepository.php</em> file inside the <em>Repository</em> directory under the module's source directory.
Below, you can find the code of <code>PostRepository</code> class that has two public methods:</p>
<ul>
<li>the <code>findPostsHavingAnyTag()</code> method is designed to select all posts that have status <em>Published</em> 
and have one or more tags assigned;</li>
<li>and the <code>findPostsByTag()</code> method is designed to return all published posts that have the particular tag
assigned (to filter posts by the given tag).</li>
</ul>
<pre class="line-numbers"><code class="language-php">&lt;?php
namespace Application\Repository;

use Doctrine\ORM\EntityRepository;
use Application\Entity\Post;

// This is the custom repository class for Post entity.
class PostRepository extends EntityRepository
{
  // Finds all published posts having any tag.
  public function findPostsHavingAnyTag()
  {
    $entityManager = $this-&gt;getEntityManager();
        
    $queryBuilder = $entityManager-&gt;createQueryBuilder();
    
    $queryBuilder-&gt;select('p')
        -&gt;from(Post::class, 'p')
        -&gt;join('p.tags', 't')
        -&gt;where('p.status = ?1')
        -&gt;orderBy('p.dateCreated', 'DESC')
        -&gt;setParameter('1', Post::STATUS_PUBLISHED);
    
    $posts = $queryBuilder-&gt;getQuery()-&gt;getResult();
    
    return $posts;
  }
    
  // Finds all published posts having the given tag.
  public function findPostsByTag($tagName)
  {
    $entityManager = $this-&gt;getEntityManager();
        
    $queryBuilder = $entityManager-&gt;createQueryBuilder();
    
    $queryBuilder-&gt;select('p')
        -&gt;from(Post::class, 'p')
        -&gt;join('p.tags', 't')
        -&gt;where('p.status = ?1')
        -&gt;andWhere('t.name = ?2')
        -&gt;orderBy('p.dateCreated', 'DESC')
        -&gt;setParameter('1', Post::STATUS_PUBLISHED)
        -&gt;setParameter('2', $tagName);
    
    $posts = $queryBuilder-&gt;getQuery()-&gt;getResult();
            
    return $posts;
  }        
}
</code></pre>
<p>In the code above, we use the <em>query builder</em> to conveniently create complex DQL queries.</p>
<p>In lines 17-22, we create a query which selects all published posts ordering them by date created in descending
order. Because we join posts with tags, here we only select posts which have at least one tag. In line 24, we
execute the query. If you are curious what DQL the query builder creates, here it is: </p>
<pre class=""><code class="language-text">SELECT p FROM \Application\Entity\Post p JOIN p.tags t 
WHERE p.status=?1 ORDER BY p.dateCreated DESC
</code></pre>
<p>In lines 36-43, we create a query that filters posts by tag name. An analogous DQL is presented below:</p>
<pre class=""><code class="language-text">SELECT p FROM \Application\Entity\Post p JOIN p.tags t 
WHERE p.status=?1 AND t.name=?2 ORDER BY p.dateCreated DESC
</code></pre>
<blockquote class="notquote tip" data-type="tip"><p> To learn more about Doctrine query builder, please refer to 
 <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/query-builder.html">this page</a>.</p>
</blockquote><p>To let Doctrine know that it should use the custom repository for <code>Post</code> entity, 
modify the <code>Post</code> entity's annotation as follows:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
//...

/**
 * This class represents a single post in a blog.
 * @ORM\Entity(repositoryClass="\Application\Repository\PostRepository")
 * @ORM\Table(name="post")
 */
class Post 
{
  //...
}
</code></pre>
<p>Above, in line 6, we use the <code>repositoryClass</code> parameter of the <code>@ORM\Entity</code> tag to tell Doctrine
that it should use <code>PostRepository</code> repository.</p>
<h3 id="header-321">12.14.2. Calculating Tag Cloud</h3>
<p>Business logic for the tag cloud feature will be stored inside of the <code>PostManager::getTagCloud()</code> method,
as follows:</p>
<pre class=""><code class="language-php">&lt;?php
//...
class PostManager 
{
  //...
	
  // Calculates frequencies of tag usage.
  public function getTagCloud()
  {
    $tagCloud = [];
               
    $posts = $this-&gt;entityManager-&gt;getRepository(Post::class)
                    -&gt;findPostsHavingAnyTag();
    $totalPostCount = count($posts);
        
    $tags = $this-&gt;entityManager-&gt;getRepository(Tag::class)
                -&gt;findAll();
    foreach ($tags as $tag) {
            
      $postsByTag = $this-&gt;entityManager-&gt;getRepository(Post::class)
                    -&gt;findPostsByTag($tag-&gt;getName());
            
      $postCount = count($postsByTag);
      if ($postCount &gt; 0) {
        $tagCloud[$tag-&gt;getName()] = $postCount;
      }
    }
        
    $normalizedTagCloud = [];
        
    // Normalize
    foreach ($tagCloud as $name=&gt;$postCount) {
      $normalizedTagCloud[$name] =  $postCount/$totalPostCount;
    }
        
    return $normalizedTagCloud;
  }
}
</code></pre>
<p>In the code above, we have the <code>getTagCloud()</code> method that selects all post having at least
one tag attached and calculates the "frequency" of each available tag (how often the tag appears).
Then it normalizes the frequency valies (makes them to be between 0 and 1.0).</p>
<h3 id="header-322">12.14.3. Modifying Controller Action</h3>
<p>Here we will modify the <code>IndexController</code> to implement tag filter.</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
//...
class IndexController extends AbstractActionController 
{
    /**
     * Post manager.
     * @var Application\Service\PostManager 
     */
    private $postManager;
    
    // Constructor is used for injecting dependencies into the controller.
    public function __construct($entityManager, $postManager) 
    {
        $this-&gt;entityManager = $entityManager;
        $this-&gt;postManager = $postManager;
    }
    
    public function indexAction() 
    {
        $tagFilter = $this-&gt;params()-&gt;fromQuery('tag', null);
        
        if ($tagFilter) {
         
            // Filter posts by tag
            $posts = $this-&gt;entityManager-&gt;getRepository(Post::class)
                    -&gt;findPostsByTag($tagFilter);
            
        } else {
            // Get recent posts
            $posts = $this-&gt;entityManager-&gt;getRepository(Post::class)
                    -&gt;findBy(['status'=&gt;Post::STATUS_PUBLISHED], 
                             ['dateCreated'=&gt;'DESC']);
        }
        
        // Get popular tags.
        $tagCloud = $this-&gt;postManager-&gt;getTagCloud();
        
        // Render the view template.
        return new ViewModel([
            'posts' =&gt; $posts,
            'postManager' =&gt; $this-&gt;postManager,
            'tagCloud' =&gt; $tagCloud
        ]);
    }
}
</code></pre>
<p>The action method will retrieve the tag from the GET variable <code>tag</code> if the variable doesn't
present in HTTP request, all posts are retrieved as usual. If the variable present, we use our
custom repository's <code>findPostsByTag()</code> method to filter posts.</p>
<p>In line 36, we call the <code>PostManager::getTagCloud()</code> that returns array of tags and their frequencies.
We use this information for rendering the cloud.</p>
<blockquote class="notquote information" data-type="information"><p> Please note that we are now using the <code>PostManager</code> service in our controller and have to inject it into
 the constructor. Do not forget to modify the controller factory to do that.</p>
</blockquote><h3 id="header-323">12.14.4. Rendering Tag Cloud</h3>
<p>Finally, modify the <em>index.phtml</em> file to make it look like follows:</p>
<pre class=""><code class="language-php">&lt;h1&gt;Posts&lt;/h1&gt;

&lt;div class="row"&gt;
    
    &lt;div class="col-md-8"&gt;

    &lt;?php foreach($posts as $post): ?&gt;

    &lt;h3&gt;
        &lt;a href="&lt;?= $this-&gt;url('posts', ['action'=&gt;'view', 'id'=&gt;$post-&gt;getId()]); ?&gt;"&gt;
            &lt;?= $this-&gt;escapeHtml($post-&gt;getTitle()); ?&gt;
        &lt;/a&gt;    
    &lt;/h3&gt;
    
    &lt;p&gt;
        Published: &lt;?= $this-&gt;escapeHtml(date('jS \of F Y', strtotime($post-&gt;getDateCreated()))); ?&gt; 
        | Tags: &lt;?= $this-&gt;escapeHtml($postManager-&gt;convertTagsToString($post)); ?&gt;   
    &lt;/p&gt;    
        
    &lt;p class="comments-header"&gt;
        &lt;?= $this-&gt;escapeHtml($postManager-&gt;getCommentCountStr($post)); ?&gt; | 
        &lt;a href="&lt;?= $this-&gt;url('posts', ['action'=&gt;'view', 'id'=&gt;$post-&gt;getId()],
                ['fragment'=&gt;'comment']); ?&gt;"&gt;
            Add new comment
        &lt;/a&gt;
    &lt;/p&gt;

    &lt;p&gt;    
        &lt;?= $this-&gt;escapeHtml($post-&gt;getContent()); ?&gt;
    &lt;/p&gt;

    &lt;?php endforeach; ?&gt;

    &lt;/div&gt;
    
    &lt;div class="col-md-4"&gt;
        &lt;div class="panel panel-default"&gt;
            &lt;div class="panel-heading"&gt;
                &lt;h3 class="panel-title"&gt;Popular Tags&lt;/h3&gt;
            &lt;/div&gt;
            &lt;div class="panel-body"&gt;
                &lt;?php foreach($this-&gt;tagCloud as $tagName=&gt;$frequency): ?&gt;
                
                &lt;a href="&lt;?= $this-&gt;url('application', ['action'=&gt;'index'],
                    ['query'=&gt;['tag'=&gt;$tagName]]); ?&gt;"&gt;                   
        
                    &lt;span style="font-size:&lt;?= $this-&gt;escapeHtml(0.9+$frequency*3) ?&gt;em"&gt;
                        &lt;?= $this-&gt;escapeHtml($tagName); ?&gt;
                    &lt;/span&gt;
                
                &lt;/a&gt;    
                    
                &lt;?php endforeach; ?&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>Hooray! Our blog application is ready now. </p>
        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Chapter - Bottom - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="1546211126"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Database_Management_with_Doctrine_ORM.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Database Management with Doctrine ORM</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Database_Management_with_Doctrine_ORM/Implementing_Admin_Page.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Database_Management_with_Doctrine_ORM/Summary.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright (c) 2016 by Oleg Krivtsov            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a> on 2016-09-11 at 23:08            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

