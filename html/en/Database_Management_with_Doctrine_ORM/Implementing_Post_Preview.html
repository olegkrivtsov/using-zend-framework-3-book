<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free and open-source book about Zend Framework">
<meta name="keywords" content="php,zend framework,book,tutorial,documentation,learn,free">
<meta name="author" content="2018 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Implementing Post Preview &ndash; Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free and open-source book about Zend Framework            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Home</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/zf3-api-reference/html/">Class Reference</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Database_Management_with_Doctrine_ORM/Deleting_a_Post.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Database_Management_with_Doctrine_ORM/Implementing_Admin_Page.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Database_Management_with_Doctrine_ORM.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Database Management with Doctrine ORM</span>
        </a>
    </div>
    </div>

﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Book - Chapter - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="4531860323"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Chapter content -->
<div id="chapter_content">

<h2 id="Implementing_Post_Preview">12.12. Implementing Post Preview</h2>
<p>In this section, we will create controller's action and its corresponding view template that would
allow site visitors to preview certain post by entering the following URL in browser's navigation
bar: <em>http://localhost/posts/view/&lt;id&gt;</em>, where <em>&lt;id&gt;</em> is the unique identifier 
of the post.</p>
<p>The page will also allow to add comments to the post using the form located at the bottom of the page.
For example of what we are trying to achive, please look at the figure 12.9 below:</p>
<p><span class="image-wrapper">
<a target="_blank" href="../images/doctrine/view_post.png">
<img src="../images/doctrine/view_post.png" alt="Figure 12.9. View Post page" /></a>
<span class="image-caption">Figure 12.9. View Post page</span>
</span>
 </p>
<p>So, for this we need four things:</p>
<ul>
<li>to create the form that would allow to enter the comment and its author's name;</li>
<li>to modify the <code>PostManager</code> and add all necessary business logic;</li>
<li>to create <code>PostController::viewAction()</code> controller's action;</li>
<li>and to create the <em>view.phtml</em> view template.</li>
</ul>
<h3 id="Adding_CommentForm">12.12.1. Adding CommentForm</h3>
<p>First, we implement the <code>CommentForm</code> form that will allow to add a comment to a post. 
Create the <em>CommentForm.php</em> file in <em>Form</em> directory under module's source directory. 
Put the following content into the file:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
namespace Application\Form;

use Zend\Form\Form;
use Zend\InputFilter\InputFilter;

/**
 * This form is used to collect comment data.
 */
class CommentForm extends Form
{
  // Constructor.     
  public function __construct()
  {
    // Define form name
    parent::__construct('comment-form');
     
    // Set POST method for this form
    $this-&gt;setAttribute('method', 'post');
                
    $this-&gt;addElements();
    $this-&gt;addInputFilter();         
  }
    
  // This method adds elements to form (input fields and submit button).
  protected function addElements() 
  {
    // Add "author" field
    $this-&gt;add([     
            'type'  =&gt; 'text',
            'name' =&gt; 'author',
            'attributes' =&gt; [
                'id' =&gt; 'author'
            ],
            'options' =&gt; [
                'label' =&gt; 'Author',
            ],
        ]);
        
    // Add "comment" field
    $this-&gt;add([            
           'type'  =&gt; 'textarea',
            'name' =&gt; 'comment',
            'attributes' =&gt; [
                'id' =&gt; 'comment'
            ],
            'options' =&gt; [
                'label' =&gt; 'Comment',
            ],
        ]);
                
    // Add the submit button
    $this-&gt;add([
            'type'  =&gt; 'submit',
            'name' =&gt; 'submit',
            'attributes' =&gt; [                
                'value' =&gt; 'Save',
                'id' =&gt; 'submitbutton',
            ],
        ]);
  }
    
  // This method creates input filter (used for form filtering/validation).
  private function addInputFilter() 
  {
    $inputFilter = new InputFilter();        
    $this-&gt;setInputFilter($inputFilter);
        
    $inputFilter-&gt;add([
                'name'     =&gt; 'author',
                'required' =&gt; true,
                'filters'  =&gt; [                    
                    ['name' =&gt; 'StringTrim'],
                ],                
                'validators' =&gt; [
                    [
                        'name'    =&gt; 'StringLength',
                        'options' =&gt; [
                            'min' =&gt; 1,
                            'max' =&gt; 128
                        ],
                    ],
                ],
            ]);
        
    $inputFilter-&gt;add([
                'name'     =&gt; 'comment',
                'required' =&gt; true,
                'filters'  =&gt; [                    
                    ['name' =&gt; 'StripTags'],
                ],                
                'validators' =&gt; [
                    [
                        'name'    =&gt; 'StringLength',
                        'options' =&gt; [
                            'min' =&gt; 1,
                            'max' =&gt; 4096
                        ],
                    ],
                ],
            ]);   
  }
}
</code></pre>
<p>As you see from the code above, the <code>CommentForm</code> form contains the author, comment fields, and the Submit button.</p>
<blockquote class="notquote information" data-type="information"><p> Since we covered forms in details in previous chapters, here we do not explain the code 
 presented above deeply.</p>
</blockquote><h3 id="Modifying_PostManager">12.12.2. Modifying PostManager</h3>
<p>Here, we add two methods:</p>
<ul>
<li>the <code>getCommentCountStr()</code> method will format the comment count string for the given post 
(e.g., "No comments", "1 comment", "2 comments", etc.)</li>
<li>and the <code>addCommentToPost()</code> method will be used for adding a new comment to post.</li>
</ul>
<pre class=""><code class="language-php">&lt;?php
//...

/**
 * The PostManager service is responsible for adding new posts.
 */
class PostManager
{
    //...    

    // Returns count of comments for given post as properly formatted string.
    public function getCommentCountStr($post)
    {
        $commentCount = count($post-&gt;getComments());
        if ($commentCount == 0)
            return 'No comments';
        else if ($commentCount == 1) 
            return '1 comment';
        else
            return $commentCount . ' comments';
    }


    // This method adds a new comment to post.
    public function addCommentToPost($post, $data) 
    {
        // Create new Comment entity.
        $comment = new Comment();
        $comment-&gt;setPost($post);
        $comment-&gt;setAuthor($data['author']);
        $comment-&gt;setContent($data['comment']);        
        $currentDate = date('Y-m-d H:i:s');
        $comment-&gt;setDateCreated($currentDate);

        // Add the entity to entity manager.
        $this-&gt;entityManager-&gt;persist($comment);

        // Apply changes.
        $this-&gt;entityManager-&gt;flush();
    }
}
</code></pre>
<h3 id="Adding_Controller_Action_and_View_Template">12.12.3. Adding Controller Action and View Template</h3>
<p>Now, add the <code>PostController::viewAction()</code> method and put the following code there:</p>
<pre class=""><code class="language-php">&lt;?php
//...
use Application\Form\CommentForm;
use Application\Entity\Comment;

class PostController extends AbstractActionController 
{
  /**
   * This action displays the "View Post" page allowing to see the post title
   * and content. The page also contains a form allowing
   * to add a comment to post. 
   */
  public function viewAction() 
  {       
    $postId = $this-&gt;params()-&gt;fromRoute('id', -1);
        
    $post = $this-&gt;entityManager-&gt;getRepository(Post::class)
              -&gt;findOneById($postId);
        
    if ($post == null) {
      $this-&gt;getResponse()-&gt;setStatusCode(404);
      return;                        
    }        
        
    $commentCount = $this-&gt;postManager-&gt;getCommentCountStr($post);
        
    // Create the form.
    $form = new CommentForm();
        
    // Check whether this post is a POST request.
    if($this-&gt;getRequest()-&gt;isPost()) {
            
      // Get POST data.
      $data = $this-&gt;params()-&gt;fromPost();
            
      // Fill form with data.
      $form-&gt;setData($data);
      if($form-&gt;isValid()) {
                                
        // Get validated form data.
        $data = $form-&gt;getData();
              
        // Use post manager service to add new comment to post.
        $this-&gt;postManager-&gt;addCommentToPost($post, $data);
                
        // Redirect the user again to "view" page.
        return $this-&gt;redirect()-&gt;toRoute('posts', ['action'=&gt;'view', 'id'=&gt;$postId]);
      }
    }
        
    // Render the view template.
    return new ViewModel([
      'post' =&gt; $post,
      'commentCount' =&gt; $commentCount,
      'form' =&gt; $form,
      'postManager' =&gt; $this-&gt;postManager
    ]);
  }      
}
</code></pre>
<p>Finally, add the <em>view.phtml</em> view template file and put the following content there:</p>
<pre class=""><code class="language-php">&lt;?php
$form = $this-&gt;form;
$form-&gt;get('author')-&gt;setAttributes([
    'class'=&gt;'form-control', 
    'placeholder'=&gt;'Author\'s name'
    ]);
$form-&gt;get('comment')-&gt;setAttributes([
    'class'=&gt;'form-control',
    'rows'=&gt;6, 
    'placeholder'=&gt;'Text'
    ]);
$form-&gt;get('submit')-&gt;setAttributes(['class'=&gt;'btn btn-primary']);
$form-&gt;prepare();        
?&gt;

&lt;a href="
    &lt;?= $this-&gt;url('application', ['action'=&gt;'index']); ?&gt;"&gt;
    &amp;lt;&amp;lt; Back to list of posts
&lt;/a&gt;

&lt;h1&gt;
    &lt;?= $this-&gt;escapeHtml($post-&gt;getTitle()); ?&gt;    
&lt;/h1&gt;

&lt;p class="comments-header"&gt;
    &lt;?= $this-&gt;escapeHtml($postManager-&gt;getCommentCountStr($post)); ?&gt; | 
    &lt;a href="#comment"&gt;
        Add new comment
    &lt;/a&gt;
&lt;/p&gt;

&lt;p&gt;
    Published: &lt;?= $this-&gt;escapeHtml(date('jS \of F Y', strtotime($post-&gt;getDateCreated()))); ?&gt; 
    | Tags: &lt;?= $this-&gt;escapeHtml($postManager-&gt;convertTagsToString($post)); ?&gt;   
&lt;/p&gt;

&lt;p&gt;    
    &lt;?= $this-&gt;escapeHtml($post-&gt;getContent()); ?&gt;
&lt;/p&gt;

&lt;h3&gt;&lt;?= $this-&gt;escapeHtml($postManager-&gt;getCommentCountStr($post)); ?&gt;&lt;/h3&gt;

&lt;?php foreach ($post-&gt;getComments() as $comment): ?&gt;

&lt;hr&gt;

&lt;p&gt;
    &lt;?= $this-&gt;escapeHtml($comment-&gt;getAuthor()) ?&gt; on 
    &lt;?= $this-&gt;escapeHtml($comment-&gt;getDateCreated()); ?&gt;
&lt;/p&gt;

&lt;p&gt;
    &lt;?= $this-&gt;escapeHtml($comment-&gt;getContent()); ?&gt;    
&lt;/p&gt;

&lt;?php endforeach; ?&gt;

&lt;hr&gt;

&lt;a name="comment"&gt;&lt;/a&gt;
&lt;h3&gt;Leave Reply&lt;/h3&gt;

&lt;div class="row"&gt;
    &lt;div class="col-md-8"&gt;
        &lt;?= $this-&gt;form()-&gt;openTag($form); ?&gt;
        
        &lt;div class="form-group"&gt;
            &lt;?= $this-&gt;formLabel($form-&gt;get('author')); ?&gt;
            &lt;?= $this-&gt;formElement($form-&gt;get('author')); ?&gt;
            &lt;?= $this-&gt;formElementErrors($form-&gt;get('author')); ?&gt;                  
        &lt;/div&gt;
        
        &lt;div class="form-group"&gt;
            &lt;?= $this-&gt;formLabel($form-&gt;get('comment')); ?&gt;
            &lt;?= $this-&gt;formElement($form-&gt;get('comment')); ?&gt;
            &lt;?= $this-&gt;formElementErrors($form-&gt;get('comment')); ?&gt;                  
        &lt;/div&gt;
        
        &lt;?= $this-&gt;formElement($form-&gt;get('submit')); ?&gt;
        
        &lt;?= $this-&gt;form()-&gt;closeTag(); ?&gt;
    &lt;/div&gt;    
&lt;/div&gt;   
</code></pre>
        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Chapter - Bottom - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="1546211126"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Database_Management_with_Doctrine_ORM.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Database Management with Doctrine ORM</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Database_Management_with_Doctrine_ORM/Deleting_a_Post.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Database_Management_with_Doctrine_ORM/Implementing_Admin_Page.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright &copy; 2018 by Oleg Krivtsov            </div>
            <div class="footer-menu">
                                <div class="footer-link">
                    <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/legal/terms-and-conditions.html">Terms &amp; Conditions</a>
                </div>
                                <div class="footer-link">
                    <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/legal/copyright-policy.html">Copyright Policy</a>
                </div>
                                <div class="footer-link">
                    <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/legal/privacy-policy.html">Privacy Policy</a>
                </div>
                            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a>
            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>
<script src="../../assets/js/popup.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

