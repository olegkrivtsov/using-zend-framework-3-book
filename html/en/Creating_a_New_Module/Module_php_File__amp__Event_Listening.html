<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free and open-source book about Zend Framework">
<meta name="keywords" content="php,zend framework,book,tutorial,documentation,learn,free">
<meta name="author" content="(c) 2016 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Module.php File &amp; Event Listening -- Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free and open-source book about Zend Framework            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Read</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Creating_a_New_Module/How_to_Create_a_New_Module_.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Creating_a_New_Module/Registering_the_Module_as_a_Composer_Package.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Creating_a_New_Module.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Creating a New Module</span>
        </a>
    </div>
    </div>


<!-- Chapter content -->
<div id="chapter_content">

<h2 id="Module_php_File__amp__Event_Listening">14.3. Module.php File &amp; Event Listening</h2>
<p>The <code>Module.php</code> file located inside of module's source directory is some kind of module <em>entry point</em>.
The <code>Module</code> class defined in this file is loaded by <code>Zend\ModuleManager</code> component when it loads all application 
modules. </p>
<p>One useful thing you can do with this class is <em>registering to events</em>. If you remember from the <a href="../Website_Operation.html">Website Operation</a>
chapter, the application has several life stages represented by events. You may write an event listener function (or class) and
register it in your module entry point. When an event is triggered, your listener method (or class) will be called allowing you to
do something useful.</p>
<blockquote class="notquote question" data-type="question"><p> <strong>Why would I want to register an event listener?</strong></p>
<p> Here are several practical applications of event listening that you may find useful:</p>
<ul>
<li>Listen to <em>Route</em> event to force the use of HTTPS secure connection.</li>
<li>When your website is in maintenance mode, listen to <em>Route</em> event to catch all requests and redirect user to the single page.</li>
<li>Listen to <em>Dispatch</em> event to redirect a user to a different page. For example, if user is not authenticated, redirect him to the login page.</li>
<li>Listen to <em>Dispatch</em> event to override the default layout template for all controllers belonging to the module.</li>
<li>Listen to <em>Dispatch Error</em> event to log and/or report any exception or error happening in your website.</li>
<li>Listen to <em>Render</em> event to modify the content of the resulting web page.  </li>
</ul>
</blockquote><p>There are two ways to register an event listener within the <code>Module</code> class: either with the help of <code>Module</code>'s <code>init()</code> method or with the
help of its <code>onBootstrap()</code> method. The difference between <code>init()</code> method and <code>onBootstrap()</code> method is that the <code>init()</code> method is called
earlier than <code>onBootstrap()</code>, before all other modules are initialized; while <code>onBootstrap()</code> is called once all modules are initialized.
In the following examples, we use <code>init()</code> method. </p>
<h3 id="Example_1__Switching_Layout_Template">14.3.1. Example 1. Switching Layout Template</h3>
<p>To show you how to subscribe to an event, let's create an event listener that will react on <em>Dispatch</em> event and
set a different layout template for <em>all</em> controllers of the module:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
namespace YourCompanyModule;

use Zend\ModuleManager\ModuleManager;
use Zend\Mvc\MvcEvent;

class Module
{
    // The "init" method is called on application start-up and 
    // allows to register an event listener.
    public function init(ModuleManager $manager)
    {
        // Get event manager.
        $eventManager = $manager-&gt;getEventManager();
        $sharedEventManager = $eventManager-&gt;getSharedManager();
        // Register the event listener method. 
        $sharedEventManager-&gt;attach(__NAMESPACE__, 'dispatch', 
                                    [$this, 'onDispatch'], 100);
    }
    
    // Event listener method.
    public function onDispatch(MvcEvent $event)
    {
        // Get controller to which the HTTP request was dispatched.
        $controller = $event-&gt;getTarget();
        // Get fully qualified class name of the controller.
        $controllerClass = get_class($controller);
        // Get module name of the controller.
        $moduleNamespace = substr($controllerClass, 0, strpos($controllerClass, '\\'));
           
        // Switch layout only for controllers belonging to our module.
        if ($moduleNamespace == __NAMESPACE__) {
            $viewModel = $event-&gt;getViewModel();
            $viewModel-&gt;setTemplate('layout/layout2');  
        }        
    }
    
    // ...
}
</code></pre>
<p>In the code above, we add the <code>init()</code> method to the <code>Module</code> class. In that method, we register an event listener (line 17)
with the help of <code>attach()</code> method provided by the <code>Zend\EventManager\SharedEventManager</code> class. The <code>attach()</code> method
takes four arguments: the ID of the emitting component, the event name ("dispatch"), the event listener method (the <code>onDispatch()</code> 
method of the current class), and the priority (100)).</p>
<p>The <code>onDispatch()</code> method is called on the Dispatch event. In this method, we check (line 32) if the HTTP request is
dispatched to the controller belonging to our module, and if so, switch the layout template (line 34).</p>
<h3 id="Example_2__Forcing_the_Use_of_HTTPS">14.3.2. Example 2. Forcing the Use of HTTPS</h3>
<p>In this example, we will show how to register an event listener that makes the website to always use HTTPS connection
with all of your web pages:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
namespace YourCompanyModule;

use Zend\ModuleManager\ModuleManager;
use Zend\Mvc\MvcEvent;

class Module
{
    // The "init" method is called on application start-up and 
    // allows to register an event listener.
    public function init(ModuleManager $manager)
    {
        // Get event manager.
        $eventManager = $manager-&gt;getEventManager();
        $sharedEventManager = $eventManager-&gt;getSharedManager();
        // Register the event listener method. 
        $sharedEventManager-&gt;attach(__NAMESPACE__, 'route', 
                                    [$this, 'onRoute'], 100);
    }
    
    // Event listener method.
    public function onRoute(MvcEvent $event)
    {
        if (php_sapi_name() == "cli") {
            // Do not execute HTTPS redirect in console mode.
            return;
        }
        
        // Get request URI
        $uri = $event-&gt;getRequest()-&gt;getUri();
        $scheme = $uri-&gt;getScheme();
        // If scheme is not HTTPS, redirect to the same URI, but with
        // HTTPS scheme.
        if ($scheme != 'https'){
            $uri-&gt;setScheme('https');
            $response=$event-&gt;getResponse();
            $response-&gt;getHeaders()-&gt;addHeaderLine('Location', $uri);
            $response-&gt;setStatusCode(301);
            $response-&gt;sendHeaders();
            return $response;
        }
    }
    
    // ...
}
</code></pre>
<p>In the code above, we register an event listener method that is called on <em>Route</em> event.</p>
<p>Inside the listener, we first check if our website is working in console mode. We do not
redirect HTTPS if in console mode.</p>
<p>Then, we extract the URI from the HTTP request and check if the current scheme is HTTPS or not.
If the scheme is not HTTPS, we redirect the user to the same URL, but with HTTPS scheme.</p>
<h3 id="Example_3__Reporting_All_Exceptions_in_Your_Website">14.3.3. Example 3. Reporting All Exceptions in Your Website</h3>
<p>With this technique, you can easily track all exceptions happending in your website. Reporting
exceptions and errors is an important thing, because it allows to make your website more stable, 
secure and improve user experience.</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
namespace YourCompanyModule;

use Zend\ModuleManager\ModuleManager;
use Zend\Mvc\MvcEvent;

class Module
{
    // The "init" method is called on application start-up and 
    // allows to register an event listener.
    public function init(ModuleManager $manager)
    {
        // Get event manager.
        $eventManager = $manager-&gt;getEventManager();
        $sharedEventManager = $eventManager-&gt;getSharedManager();
        // Register the event listener method. 
        $sharedEventManager-&gt;attach(__NAMESPACE__, MvcEvent::EVENT_DISPATCH_ERROR,
                                    [$this, 'onError'], 100);
        $sharedEventManager-&gt;attach(__NAMESPACE__, MvcEvent::EVENT_RENDER_ERROR, 
                                    [$this, 'onError'], 100);
    }
    
    // Event listener method.
    public function onError(MvcEvent $event)
    {
        // Get the exception information.
        $exception = $event-&gt;getParam('exception');
        if ($exception!=null) {
            $exceptionName = $exception-&gt;getMessage();
            $file = $exception-&gt;getFile();
            $line = $exception-&gt;getLine();
            $stackTrace = $exception-&gt;getTraceAsString();
        }
        $errorMessage = $event-&gt;getError();
        $controllerName = $event-&gt;getController();
        
        // Prepare email message.
        $to = 'admin@yourdomain.com';
        $subject = 'Your Website Exception';
        
        $body = '';
        if(isset($_SERVER['REQUEST_URI'])) {
            $body .= "Request URI: " . $_SERVER['REQUEST_URI'] . "\n\n";
        }
        $body .= "Controller: $controllerName\n";
        $body .= "Error message: $errorMessage\n";
        if ($exception!=null) {
            $body .= "Exception: $exceptionName\n";
            $body .= "File: $file\n";
            $body .= "Line: $line\n";
            $body .= "Stack trace:\n\n" . $stackTrace;
        }
        
        $body = str_replace("\n", "&lt;br&gt;", $body);
        
        // Send an email about the error.
        mail($to, $subject, $body);
    }
    
    // ...
}
</code></pre>
<p>In the code above, we register an event listener that will be called on every Dispatch Error 
(route mismatch or an exception) and Rendrer Error. Inside the <code>onError()</code> listener method,
we extract some information about the exception/error and send it as an email message to the
address of your choice.</p>
        
</div>

    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Creating_a_New_Module.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Creating a New Module</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Creating_a_New_Module/How_to_Create_a_New_Module_.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Creating_a_New_Module/Registering_the_Module_as_a_Composer_Package.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright (c) 2016 by Oleg Krivtsov            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a>
            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

